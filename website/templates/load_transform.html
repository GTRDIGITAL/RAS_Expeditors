<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Contabilitate</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <!-- Icone FontAwesome pentru Navbar -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- DataTables CSS & JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">

<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>


  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, rgb(0, 0, 0) 30%, rgba(114, 2, 2, 0.864) 50%, rgb(0, 0, 0) 60%);
      color: #333;
      margin: 0;
      padding: 0;
      background-size: cover;
      background-attachment: fixed;
    }

    .navbar {
      background-color: #000;
    }
      div.dt-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }

  .dt-button {
    background-color: #0d6efd;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 5px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .dt-button:hover {
    background-color: #0b5ed7;
  }

    .navbar-brand {
      color: #fff;
    }

    .navbar-nav .nav-link {
      color: #fff;
    }

    .navbar-nav .nav-link:hover {
      background-color: #e74c3c;
    }

    .container {
      width: 80%;
      margin-top: 120px;
      padding: 30px;
    }

    .card {
      background-color: #ecf0f1;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.6);
    }

    .card-header {
      background-color: #010101;
      color: #fff;
      /* font-size: 1.25rem; */
      font-weight: 500;
      border-radius: 30px;
      margin-top: 20px;
    }

    .card-body {
  background-color: #ecf0f1;
  color: #333;
  height: fit-content;
  border-radius: 0 0 30px 30px;
}

    .btn {
      border-radius: 25px;
      padding: 10px 25px;
      /* font-size: 1rem; */
      transition: background-color 0.3s ease;
    }

    .btn-primary {
      background-color: #e74c3c;
      border-color:white;
    }

    .btn-primary:hover {
      background-color: #c0392b;
      border-color:white;
    }

    .footer {
      text-align: center;
      padding: 20px;
      background-color: black;
      position: fixed;
      width: 100%;
      bottom: 0;
      color: #fff;
    }

    /* Sticky header for tables */
    .table thead th {
      position: sticky;
      top: 0;
      z-index: 1;
      background-color: #010101;
      color: white;
    }
    
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #333;
      color: #fff;
      padding: 15px 0;
      text-align: center;
    }

    .logo-img {
      width: 180px;
      height: 90px;
    }

    /* Scrollable table */
    .table-responsive {
      max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.1);
    }

    /* Dropdown filter styles */
    .filterable {
      position: relative;
      z-index: 10;
    }
    .dropdown-menu {
  position: fixed; /* Plasăm dropdown-ul peste tot */
  width: 250px;
  max-height: 250px;
  overflow-y: auto; /* Scroll doar pe dropdown */
  background-color: #fff;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  z-index: 1000;
  padding: 8px 0;
  box-sizing: border-box;
  border: 1px solid #ddd;
}

.filter-search input {
  width: 90%;
  padding: 8px;
  margin: 8px auto;
  display: block;
  border-radius: 5px;
  border: 1px solid #ddd;
}

.dropdown-item {
  padding: 8px 16px;
  cursor: pointer;
  border-bottom: 1px solid #f1f1f1;
  transition: background-color 0.2s ease;
}

.dropdown-item input[type="checkbox"] {
  margin-right: 8px;
}

.dropdown-item:hover {
  background-color: #f9f9f9;
}
/* Stilizare Dropdown */
.dropdown-menu {
  background-color: white;
  border: 2px solid #ddd; /* Bordură subtilă */
  border-radius: 8px; /* Colțuri rotunjite */
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Efect de umbră pentru adâncire */
  position: absolute;
  z-index: 999;
  width: 200px; /* Lățime fixă */
  max-height: 300px; /* Înălțime limitată pentru a evita overflow-ul */
  overflow-y: auto; /* Scroll pe verticală */
  transition: all 0.2s ease-in-out;
}
.dt-button {
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-weight: 500;
  font-size: 0.95rem;
  margin-right: 0.5rem;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s ease, box-shadow 0.2s ease;
}

/* Excel */
.buttons-excel {
  background-color: #198754;
  color: white;
}

.buttons-excel:hover {
  background-color: #157347;
  box-shadow: 0 0 0.5rem rgba(0, 0, 0, 0.1);
}

/* CSV */
.buttons-csv {
  background-color: #0d6efd;
  color: white;
}

.buttons-csv:hover {
  background-color: #0b5ed7;
  box-shadow: 0 0 0.5rem rgba(0, 0, 0, 0.1);
}

/* Hover pe dropdown */
.dropdown-menu:hover {
  box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15); /* Umbră mai mare la hover */
}

/* Input de căutare */
.filter-search {
  margin: 8px;
  padding: 5px;
}

.filter-search input {
  width: calc(100% - 10px);
  padding: 6px 10px;
  border-radius: 4px;
  border: 1px solid #ddd;
  outline: none;
  transition: border 0.2s ease-in-out;
  /* font-size: 14px; */
}

/* Când input-ul de căutare e în focus */
.filter-search input:focus {
  border-color: #4CAF50;
}

/* Dropdown items */
.dropdown-item {
  padding: 10px 12px;
  font-size: 14px;
  display: flex;
  
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* Hover pe itemele din dropdown */
.dropdown-item:hover {
  background-color: #f1f1f1; /* Fundal ușor gri la hover */
  color: #388E3C; /* Culoare verde pentru text */
}

/* Stilizare pentru "Selectează toate" */
.select-all {
  font-weight: bold;
  padding: 10px 12px;
  background-color: #dedbdb;
  border-top: 1px solid #ddd;
  transition: background-color 0.3s ease;
}

/* Hover pe "Selectează toate" */
.select-all:hover {
  background-color: #f0f0f0;
}

/* Input pentru checkboxuri - Stilit unitar cu dropdown */
input[type="checkbox"] {
  appearance: none;
  width: 18px;
  height: 18px;
  border: 2px solid #4CAF50;  /* Verde */
  border-radius: 4px;
  position: relative;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

/* Când checkbox-ul e selectat */
input[type="checkbox"]:checked {
  background-color: #4CAF50;
  border-color: #4CAF50;
}

/* Bifa la checkbox */
input[type="checkbox"]::after {
  content: "✔";
  font-size: 14px;
  color: white;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: none;
}

/* Afișează bifa când checkbox-ul este selectat */
input[type="checkbox"]:checked::after {
  display: block;
}

/* Input text pentru căutare */
.filter-search input {
  border-radius: 4px;
  padding: 8px 12px;
  width: 100%;
  border: 1px solid #ddd;
  font-size: 14px;
  outline: none;
}

/* Când input-ul de căutare e activ */
.filter-search input:focus {
  border-color: #4CAF50;
  box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); /* Efect de focus */
}

.clear-filter {
  display: flex;
  justify-content: center;
  margin-bottom: 8px;
}

.clear-filter button {
  background: #ff4d4d;
  color: white;
  border: none;
  padding: 6px 12px;
  font-size: 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.3s ease;
}

.clear-filter button:hover {
  background: #cc0000;
  color:white;
}
.card-header {
            background-color: black;
            color: white;
        }
        .btn {
            border-radius: 5px;
            font-weight: 600;
        }
        .btn-outline-primary {
            border-color: #ffffff;
            color: #ffffff;
        }
        .btn-outline-success {
            border-color: #f7f7f7;
            color: #ffffff;
        }
        .btn-outline-warning {
            border-color: #ffffff;
            color: #ffffff;
        }
        .btn-outline-primary:hover {
            border-color: #ffffff;
            color: #ffffff;
            background-color: #010101;
        }
        .btn-outline-success:hover {
            border-color: #f7f7f7;
            color: #ffffff;
            background-color: #010101;
        }
        .btn-outline-warning:hover {
            border-color: #ffffff;
            color: #ffffff;
            background-color: #010101;
        }
        .card {
            margin-bottom: 20px;
            background-color: #333;
        }
        .card-body {
            background-color: #ffffff; /* gri */
        }
        .label{
          color:white;
        }
        .card {
    background: #e23232;
    border-radius: 16px;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease-in-out;
    border-bottom-left-radius: 50px; /* Increased bottom-left radius */
    border-bottom-right-radius: 50px; /* Increased bottom-right radius */
}
        
        .card:hover {
            transform: translateY(-10px); /* Efect de ridicare la hover */
        }
        .table th, .table td {
            text-align: center;
            vertical-align: middle;
        }

        .btn-custom {
            margin: 5px;
        }

        .modal-content {
            background: #ffffff;
            color: black;
        }

        .form-control {
            background: #ecf0f1;
            border-radius: 5px;
            box-shadow: none;
        }
        
        /* Table Row Hover Effect */
        tr:hover {
            background-color: #f4f4f4;
            cursor: pointer;
        }

        .card-header {
            background: #000000; /* Gri închis */
            color: #fff;
            /* font-size: 1.4rem; */
            text-align: center;
            padding: 25px 20px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .card-body {
            padding: 30px;
            text-align: center;
        }

        /* Button links */
        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 25px;
            justify-content: center;
        }

        .btn {
            font-weight: 700;
            /* font-size: 1.1rem; */
            text-transform: uppercase;
            padding: 14px 30px;
            border-radius: 50px;
            border: none;
            position: relative;
            background-color: black;
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.4s ease;
        }

        /* Color effects for buttons */
        .btn-outline-primary {
            border: 2px solid #000000;
            color: #ffffff;
        }
        .btn-outline-primary:hover {
            background-color: #000000;
            color: #fff;
            box-shadow: 0 4px 30px rgba(138, 140, 141, 0.6);
        }

        .btn-outline-success {
            border: 2px solid #000000;
            color: white;
        }
        .btn-outline-success:hover {
            background-color: #000000;
            color: #fff;
            box-shadow: 0 4px 30px rgba(95, 97, 93, 0.6);
        }

        .btn-outline-warning {
            border: 2px solid #000000;
            color: #ffffff;
        }
        .btn-outline-warning:hover {
            background-color: #000000;
            color: #fff;
            box-shadow: 0 4px 30px rgba(126, 125, 118, 0.6);
        }

        /* Hover glow effect */
        .btn:hover::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            animation: glow 1.5s ease-out infinite;
        }

        /* Glow animation */
        @keyframes glow {
            0% {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
            }
            100% {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .btn {
                /* font-size: 1rem; */
                padding: 12px 25px;
            }
           
        }
        .label{
          color:rgb(0, 0, 0);
        }
        h5{
          color:white;
        }
          #historySidebar {
    position: fixed;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    width: 40px;
    height: 140px;
    background: #0d6efd; /* bootstrap primary */
    border-top-right-radius: 8px;
    border-bottom-right-radius: 8px;
    color: white;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: width 0.3s ease;
    overflow: hidden;
    z-index: 1050;
    box-shadow: 0 0 5px rgba(0,0,0,0.15);
  }

  /* Când e extins */
  #historySidebar.expanded {
    width: 320px;
    height: 500px;
    border-radius: 0 8px 8px 0;
    background: white;
    color: #212529;
    box-shadow: 2px 0 10px rgba(0,0,0,0.2);
  }

  /* Text și icon din sidebar */
  #historySidebar .sidebar-label {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    font-weight: 600;
    font-size: 1rem;
    user-select: none;
  }

  #historySidebar.expanded .sidebar-label {
    writing-mode: horizontal-tb;
    margin: 10px 0;
    color: #0d6efd;
    font-weight: 700;
  }

  /* Container conținut când extins */
  #historyContent {
    display: none;
    padding: 0 15px 15px 15px;
    overflow-y: auto;
    height: 100%;
  }

  #historySidebar.expanded #historyContent {
    display: block;
  }

  /* Buton închidere */
  #closeHistoryBtn {
    cursor: pointer;
    font-size: 1.3rem;
    font-weight: bold;
    color: #0d6efd;
    text-align: right;
    user-select: none;
  }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('views.main', email=session['email']) }}">
        <img src="static/unnamed.jpg" alt="Logo" class="logo-img">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('views.main', email=session['email']) }}">Dashboard</a>
          </li>

          <!-- Dropdown Utilizatori -->
          <li class="nav-item dropdown" id="usersDropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button">
              Utilizatori
            </a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdown" >
              <li><a class="dropdown-item" href="{{ url_for('auth.create_new_user') }}">Creare utilizator nou</a></li>
              <li><a class="dropdown-item" href="{{ url_for('views.users',  email=session['email']) }}">Afisare și gestionare utilizatori</a></li>
            </ul>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('views.generate_reports')}}">Generare Rapoarte</a>
          </li>
            <li class="nav-item">
            <a class="nav-link" href="{{ url_for('views.generate_monthlyTB', email=session['email']) }}">Generare Monthly TB</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('views.load_transform',  email=session['email']) }}">Transformă & Încarcă GL</a>
          </li>

          <!-- Dropdown Utilizator Autentificat -->
          <li class="nav-item dropdown" id="userDropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button">
              <i class="fas fa-user"></i> <span id="username">{{user_name}}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="{{ url_for('auth.change_password') }}"><i class="fas fa-key"></i> Change Password</a></li>
              <li><a class="dropdown-item" href="{{ url_for('auth.login') }}"><i class="fas fa-sign-out-alt"></i> Sign Out</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>
<!-- 🔥 Pune asta în locul tuturor toasturilor tale existente -->
<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1080"></div>

<div id="historySidebar" class="extended" title="Istoric documente">
  <div class="sidebar-label">
   History
  </div>
  <div id="historyContent">
    <div id="closeHistoryBtn">&times;</div>

    {% macro accordion_history(title, icon, data, empty_msg, accordion_id) %}
      <div class="card mt-3">
        <div class="card-header bg-dark text-white d-flex align-items-center">
          <i class="bi {{ icon }} me-1"></i> {{ title }}
        </div>
        <div class="card-body p-2">
          {% if data %}
            <div class="accordion" id="{{ accordion_id }}">
              {% for an, luni in data.items() %}
                <div class="accordion-item">
                  <h2 class="accordion-header" id="heading-{{ accordion_id }}-{{ an }}">
                    <button class="accordion-button collapsed py-1" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ accordion_id }}-{{ an }}" aria-expanded="false" aria-controls="collapse-{{ accordion_id }}-{{ an }}">
                      {{ an }}
                    </button>
                  </h2>
                  <div id="collapse-{{ accordion_id }}-{{ an }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ accordion_id }}-{{ an }}">
                    <div class="accordion-body p-2">
                      <ul class="list-group list-group-flush small">
                        {% for luna in luni %}
                          <li class="list-group-item d-flex align-items-center py-1">
                            <i class="bi bi-calendar3 me-2 text-primary"></i> {{ luna }}
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted small mb-0">{{ empty_msg }}</p>
          {% endif %}
        </div>
      </div>
    {% endmacro %}

    {{ accordion_history('Istoric Balanțe Disponibile', 'bi-clock-history', luni_disponibile, 'Nu există balanțe înregistrate în sistem.', 'balantaAccordion') }}

    {{ accordion_history('Istoric GL Disponibile', 'bi-clock-history', luni_disponibile_gl, 'Nu există registre jurnale înregistrate în sistem.', 'glAccordion') }}
       {{ accordion_history('Istoric Sold Clienti', 'bi-clock-history', luni_disponibile_clienti, 'Nu există solduri clienti înregistrate în sistem.', 'clAccordion') }}
  {{ accordion_history('Istoric Sold Furnizori', 'bi-clock-history', luni_disponibile_furnizori, 'Nu există solduri furnizori înregistrate în sistem.', 'fzAccordion') }}
      </div>
</div>
 
  <div class="container">
   
    
    <!-- Panou de Control -->
    <div class="container-2">
      
      <div class="card mb-5">
        <div class="card-header">
          Panou de Control
        </div>
        <div class="card-body">
          <div class="nav-links">
            <a href="javascript:void(0);" onclick="toggleSection('manual-import')" class="btn btn-outline-success">Manual import</a>
            <a href="javascript:void(0);" onclick="toggleSection('periode-mapping')" class="btn btn-outline-primary">Mapare GL prin Perioadă</a>
            <a href="javascript:void(0);" onclick="toggleSection('delete-gl')" class="btn btn-outline-primary">Stergere</a>
            <a href="javascript:void(0);" onclick="toggleSection('add-entry')" class="btn btn-outline-warning">Adăugare Notă Contabilă Manual</a>
            <a href="javascript:void(0);" onclick="toggleSection('import-nc-section')" class="btn btn-outline-warning">Import Notă Contabilă</a>
            <a href="javascript:void(0);" onclick="toggleSection('show-all')" class="btn btn-outline-warning">Istoric si editare note contabile</a>
            <a href="javascript:void(0);" onclick="toggleSection('cl')" class="btn btn-outline-primary">Generare sold clienti</a>
            <a href="javascript:void(0);" onclick="toggleSection('sup')" class="btn btn-outline-primary">Generare sold furnizori</a>
            <a href="javascript:void(0);" onclick="toggleSection('map')" class="btn btn-outline-primary">Vizualizare Mapare</a>
            
            
          </div>
        </div>
      </div>
    </div>
    
    <style>
      .container-2 {
        max-width: 600px;/* reduce dimensiunea containerului */
        margin: 0 auto; /* centerază containerul */
      }
      
      .card-body {
        padding: 1rem;
      }
    
      .nav-links {
        display: flex;
        justify-content: space-between; /* aliniere mai elegantă */
        gap: 10px; /* adaugă un pic de spațiu între butoane */
      }
    
      .nav-links .btn {
        padding: 0.5rem 1rem; /* butoane mai înguste */
        font-size: 0.9rem; /* font mai mic */
        border-radius: 25px; /* margini rotunjite pentru un look mai modern */
        transition: background-color 0.3s ease; /* tranziție pentru background la hover */
      }
    
      .nav-links .btn:hover {
        opacity: 0.8; /* efect la hover */
      }

      #fileNameDisplay {
        margin-bottom: 5px; /* Add some space between the filename and the input */
        display: block; /* Ensure it takes up the full width */
    }

    #uploadButton:disabled {
    cursor: not-allowed;
}
.msg-box {
  margin-top: 10px;
  font-weight: 600;
}

/* Spinner minimalist */
.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 3px solid rgba(0,0,0,0.2);
  border-top-color: rgba(0,0,0,0.6);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  vertical-align: middle;
  margin-right: 8px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Mesaje succes / eroare */
.text-success {
  color: green;
}

.text-danger {
  color: red;
}

#importButton:disabled {
    cursor: not-allowed;
}
/* Container pentru centru absolut */
#container {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #fafafa;
  box-sizing: border-box;
}

/* Mesaj ca card elegant, centrat absolut */
.msg-box {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  min-width: 320px;
  max-width: 420px;
  padding: 18px 24px;
  padding-top: 20px !important;
  border-radius: 14px;
  box-shadow: 0 8px 16px rgba(0,0,0,0.12);
  display: flex;
  align-items: center;
  gap: 14px;
  font-weight: 600;
  font-size: 2rem!important;
  background-color: rgba(255 255 255 / 0.95);
  color: #333;
  user-select: none;
  opacity: 0;
  animation: fadeInUp 0.4s forwards;
  letter-spacing: 0.03em;
}

/* Culori mai soft și elegante */
.text-success {
  border-left: 6px solid #2a9d8f;
  color: #264653;
  background-color: #e0f2f1;
  font-size: large;
}

.text-danger {
  border-left: 6px solid #e76f51;
  color: #7b2d26;
  background-color: #fce8e6;
  font-size: large;
}

.text-loading {
  border-left: 6px solid #4a90e2;
  color: #375a7f;
  background-color: #e6f0fa;
  font-size: large;
}

/* Animație fade in cu translateY pentru un efect modern */
@keyframes fadeInUp {
  0% {
    opacity: 0;
    transform: translate(-50%, -40%);
  }
  100% {
    opacity: 1;
    transform: translate(-50%, -50%);
  }
}

/* Spinner minimalist cu linie subțire */
.spinner {
  width: 20px;
  height: 20px;
  border: 3px solid rgba(0,0,0,0.1);
  border-top-color: #4a90e2;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  flex-shrink: 0;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Emoji discrete */
.msg-box .emoji {
  font-size: 1.4rem;
  line-height: 1;
  user-select: none;
  flex-shrink: 0;
}
.dt-button {
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  background-color: #e9f2ff;
  color: #0d3b66;
  border: 1px solid #b6d4fe;
  margin-right: 0.5rem;
  font-weight: 500;
  transition: background-color 0.3s ease;
}

.dt-button:hover {
  background-color: #cfe2ff;
}



    </style>
    <!-- Clienti -->
    <div class="card mb-4" id="cl" style="display:none;">
      <div class="card-header">Generare sold clienti</div>
      <div class="card-body">
          <label class="label" for="periodeInputClienti">Introduceți perioada:</label>
          <input type="month" id="periodeInputClienti" class="form-control" placeholder="YYYY-MM">
          <div id="soldClientiMsg" class="mt-2 text-success" style="display:none;"></div>
           <div id="soldClientiMsg" style="display:none;" class="msg-box"></div>
          <button class="btn btn-primary mt-2" id="soldCLButton">Generare sold clienti</button>
           

      </div>
      </div>


    <!-- Furnizori -->
 <div class="card mb-4" id="sup" style="display:none;">
      <div class="card-header">Generare sold furnizori</div>
      <div class="card-body">
          <label class="label" for="periodeInputFurnizori">Introduceți perioada:</label>
          <input type="month" id="periodeInputFurnizori" class="form-control" placeholder="YYYY-MM">
            <div id="soldFurnizoriMsg" class="mt-2 text-success" style="display:none;"></div>
           <div id="soldFurnizoriMsg" style="display:none;" class="msg-box"></div>
          <button class="btn btn-primary mt-2" id="soldFzButton">Generare sold furnizori</button>
      </div>
      </div>



    <!-- Secțiunea 1: Introducere Perioadă și Mapare GL -->
    <div class="card mb-4" id="periode-mapping" style="display:none;">
      <div class="card-header">Mapare GL prin Perioadă</div>
      <div class="card-body">
          <label class="label" for="periodeInput">Introduceți perioada:</label>
          <input type="month" id="periodeInput" class="form-control" placeholder="YYYY-MM">
          <button class="btn btn-primary mt-2" id="mapareGLButton">
  <span class="spinner-border spinner-border-sm me-1 d-none" id="mapareSpinner" role="status" aria-hidden="true"></span>
  Mapare GL
</button>
      </div>
      </div>
  <div class="card mb-4" id="delete-gl" style="display:none;">
  <div class="card-header">Ștergere GL prin Perioadă</div>
  <div class="card-body">
    <label class="label" for="deleteGLPerioadaInput">Introduceți perioada:</label>
    <input type="month" id="deleteGLPerioadaInput" class="form-control" placeholder="YYYY-MM">

    <!-- Buton Ștergere GL -->
    <button class="btn btn-danger mt-2" id="deleteGLButton">
      <span class="spinner-border spinner-border-sm me-1 d-none" id="deleteGLSpinner" role="status" aria-hidden="true"></span>
      Șterge GL
    </button>

    <!-- Feedback mesaje -->
    <div id="deleteGLFeedback" class="mt-3 text-success d-none">GL șters cu succes.</div>
  </div>
</div>

  <div class="card mb-4" id="show-all" style="display:none;">
    <div class="card-header">Istoric Note Contabile</div>
    <div class="card-body">
      <label for="startDate">Perioadă Start:</label>
      <input type="month" id="startDate" class="form-control" placeholder="YYYY-MM">
      
      <label for="endDate" class="mt-2">Perioadă Sfârșit:</label>
      <input type="month" id="endDate" class="form-control" placeholder="YYYY-MM">
      
      <button class="btn btn-primary mt-2" onclick="extractNotes()">Extrage Note</button>
      
      <!-- Tabel cu notele contabile extrase -->
      <div class="table-responsive">
  <table class="table mt-3" id="historical-table">

        <thead>
          <tr>
            <!-- <th>#</th>
            <th>Data</th>
            <th>Descriere</th>
            <th>Sumă</th>
            <th>Acțiuni</th> -->
          </tr>
        </thead>
        <tbody>
          <!-- Liniile tabelului vor fi populate din JavaScript -->
        </tbody>
       </table>
</div>
    </div>
  </div>




  <!-- Secțiunea 2: Import Manual Excel -->
<div class="card mb-4" id="import-nc-section" style="display:none;">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Import Notă Contabilă</span>
    <!-- Buton Descărcare Template -->
    
  </div>

  <div class="card-body">
  <div>
    <a href="/static/Template_NC.xlsx" download class="btn btn-outline-primary btn-sm" title="Descarcă template Excel">
      <i class="bi bi-download me-1"></i> Template Excel
    </a>
  </div>

  <label class="form-label" for="nc-file-upload">Încarcă fișier Excel:</label>
  <input type="file" id="nc-file-upload" class="form-control">

  <span id="nc-file-name-display" style="display:none;">
    <i class="fas fa-check-circle text-success me-1"></i> Fișier selectat
  </span>

  <!-- Progress Bar -->
  <div class="progress mt-2" style="height: 20px;">
    <div id="nc-upload-progress-bar" class="progress-bar" role="progressbar"
         style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
      0%
    </div>
  </div>

  <div class="d-flex gap-2 mt-3">
    <button class="btn btn-success" id="nc-upload-button" disabled data-toggle="tooltip" title="Alege un fișier de importat">
      Upload fișier
    </button>
    <button class="btn btn-success" id="nc-import-button" disabled data-toggle="tooltip" title="Importă în baza de date">
      Importă în baza de date
    </button>
  </div>
</div>
</div>
  

  <div class="card mb-4" id="manual-import" style="display:none;">
    <div class="card-header">Manual Import for Mapping</div>
    <div class="card-body">
    <label class="label" for="fileUpload">Upload an Excel file:</label>
    <input type="file" id="fileUpload" class="form-control">
    <span id="fileNameDisplay" style="display:none;">
        <i class="fas fa-check-circle text-success me-1"></i>
    </span>

     <!-- Progress Bar -->
    <div class="progress mt-2" style="height: 20px;">
        <div id="uploadProgressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>

    <button class="btn btn-success mt-2" id="uploadButton" disabled data-toggle="tooltip" data-placement="top" title="Choose a file to import">Upload file</button>
<button class="btn btn-success mt-2" id="importButton" data-toggle="tooltip" data-placement="top" title="Import into database">
  <span class="spinner-border spinner-border-sm me-1 d-none" id="importSpinner" role="status" aria-hidden="true"></span>
  Import into database
</button>
</div>
</div>










  <div class="card mb-4" id="map" style="display:none;">
  <div class="card-header">Vizualizare mapare</div>
  <div class="card-body">
    <div id="map-section" class="mt-3">
      <div class="d-flex justify-content-end mb-3">
  <button class="btn btn-secondary" id="addRowBtn">➕ Adaugă rând</button>
</div>
        <div class="table-responsive">
  <table id="map-table" class="table table-bordered table-striped">
    <thead>
      <tr>
        {% for col in map_df[0].keys() %}
          <th>{{ col }}</th>
        {% endfor %}
        <th>Acțiuni</th>
      </tr>
    </thead>
    <tbody>
      {% for row in map_df %}
        <tr data-id="{{ row['ID'] }}">
          {% for key in map_df[0].keys() %}
            <td contenteditable="{{ 'false' if key == 'ID' else 'true' }}">{{ row[key] }}</td>
          {% endfor %}
          <!-- <td>
            <button class="btn btn-success btn-sm" onclick="editRow(this)">Salvează</button>
            <button class="btn btn-danger btn-sm" onclick="deleteRow(this)">Șterge</button>
          </td> -->
           <td>
        <button class="btn btn-outline-danger btn-sm" onclick="deleteRow(this)">Șterge</button>
      </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  <button class="btn btn-secondary mt-3" onclick="addEmptyRow()">Adaugă rând</button>
</div>
  </div>
</div>
</div>
  <!-- Secțiunea 3: Adăugare Notă Contabilă -->
<div class="card mb-4" id="add-entry" style="display: none;">
  <div class="card-header bg-dark text-white">Adăugare Înregistrare</div>
  <div class="card-body">
    <form id="entryForm">
      <div class="row">
        <!-- Coloana 1 -->
        <div class="col-md-6">
          <!-- Identificare -->
          <h5 class="mt-3 mb-3 text-black">Identificare Document</h5>
          <div class="mb-3">
            <label for="BR" class="form-label">BR</label>
            <input type="text" id="BR" name="BR" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="File_Ref" class="form-label">File Ref</label>
            <input type="text" id="File_Ref" name="File_Ref" class="form-control">
          </div>

          <!-- Contabilitate -->
          <h5 class="mt-4 mb-3 text-black">Date Contabile</h5>
          <div class="mb-3">
            <label for="Statutory_GL_D" class="form-label">Statutory GL Debit</label>
            <input type="text" id="Statutory_GL_D" name="Statutory_GL_D" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="Statutory_GL_C" class="form-label">Statutory GL Credit</label>
            <input type="text" id="Statutory_GL_C" name="Statutory_GL_C" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="Journal" class="form-label">Journal</label>
            <input type="text" id="Journal" name="Journal" class="form-control" required readonly>
            
          </div>
          
          <div class="mb-3">
            <label for="Open_Item" class="form-label">Open Item</label>
            <input type="text" id="Open_Item" name="Open_Item" class="form-control">
          </div>

          <!-- Calendar -->
          <h5 class="mt-4 mb-3 text-black">Date Calendaristice</h5>
          <div class="mb-3">
            <label for="Date" class="form-label">Data Document</label>
            <input type="date" id="Date" name="Date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="Post_Date" class="form-label">Data Postare</label>
            <input type="date" id="Post_Date" name="Post_Date" class="form-control" required>
          </div>
        </div>

        <!-- Coloana 2 -->
        <div class="col-md-6">
          <!-- Calendar continuare -->
          <h5 class="mt-3 mb-3 text-transparent">.</h5> <!-- spațiu gol pt aliniere -->
          <div class="mb-3">
            <label for="Month" class="form-label">Lună</label>
            <input type="number" id="Month" name="Month" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="Year" class="form-label">An</label>
            <input type="number" id="Year" name="Year" class="form-control" required>
          </div>

          <!-- Valori -->
          <h5 class="mt-4 mb-3 text-black">Valori & Devize</h5>
          <div class="mb-3">
  <label for="Amount" class="form-label">Suma Debit (lei)</label>
  <input type="number" id="Amount" name="Amount" class="form-control" step="0.01" required>
</div>

<div class="mb-3">
  <label for="Foreign_Amount" class="form-label">Suma Debit în valută</label>
  <input type="number" id="Foreign_Amount" name="Foreign_Amount" class="form-control" step="0.01">
</div>

<!-- Campuri blocate -->
<div class="mb-3">
  <label for="Credit_Amount" class="form-label">Suma Credit (lei)</label>
  <input type="number" id="Credit_Amount" class="form-control" step="0.01" readonly>
</div>

<div class="mb-3">
  <label for="Credit_Foreign_Amount" class="form-label">Suma Credit în valută</label>
  <input type="number" id="Credit_Foreign_Amount" class="form-control" step="0.01" readonly>
</div>
          <div class="mb-3">
            <label for="Currency" class="form-label">Currency</label>
            <select id="Currency" name="Currency" class="form-control" >
              <option value="">Selectează</option>
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
              <option value="GBP">GBP</option>
              <option value="CNY">CNY</option>
              <option value="HUF">HUF</option>
              <option value="PLN">PLN</option>
              <option value="AED">AED</option>
              <option value="KWD">KWD</option>
              <option value="SGD">SGD</option>
              <option value="QAR">QAR</option>
              <option value="KRW">KRW</option>
              <option value="SEK">SEK</option>
              <option value="CAD">CAD</option>
              <option value="SAR">SAR</option>
              <option value="AUD">AUD</option>
              <option value="OMR">OMR</option>
              <option value="HKD">HKD</option>
              <option value="CZK">CZK</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Descriere & Client -->
      <div class="row">
        <div class="col-md-6">
          <h5 class="mt-4 mb-3 text-black">Descriere și Coduri</h5>
          <div class="mb-3">
            <label for="data_Description" class="form-label">Descriere</label>
            <input type="text" id="data_Description" name="data_Description" class="form-control">
          </div>
          <div class="mb-3">
            <label for="TC" class="form-label">TC</label>
            <select id="TC" name="TC" class="form-control" >
              <option value="">Selectează</option>
              <option value="EU">EU</option>
              <option value="S">S</option>
              <option value="E">E</option>
              <option value="Z">Z</option>
              <option value="P">P</option>
              <option value="C">C</option>
            </select>
          </div>
        </div>
        <div class="col-md-6">
          <h5 class="mt-4 mb-3 text-black">Date Client</h5>
          <div class="mb-3">
            <label for="Customer_GCI" class="form-label">GCI</label>
            <input type="text" id="Customer_GCI" name="Customer_GCI" class="form-control">
          </div>
          <div class="mb-3">
            <label for="Customer_Name" class="form-label">Nume Client</label>
            <input type="text" id="Customer_Name" name="Customer_Name" class="form-control">
          </div>
        </div>
      </div>

      <!-- Buton -->
      <div class="text-end mt-4">
        <button type="button" class="btn btn-warning" id="previewButton">Previzualizează</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal pentru previzualizare -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-xl"> <!-- lățime mare -->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Previzualizare Înregistrare</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Închide"></button>
      </div>
      <div class="modal-body" id="previewContent">
        <!-- Conținutul va fi injectat aici -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Închide</button>
        <button type="button" class="btn btn-primary" id="savePreview">Salvează</button>

      </div>
    </div>
  </div>
</div>

<!-- <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
  <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Documentul a fost salvat cu succes!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Închide"></button>
    </div>
  </div>
</div> -->

<!-- Modal Detalii -->
<!-- Modal Detalii -->
<!-- Modal Detalii -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content rounded-4 border-0" style="background-color: #121212; color: #222;">
      <div class="modal-header" style="border-bottom: 3px solid #e03e3e; background-color: #ffffff;">
        <h5 class="modal-title d-flex align-items-center" id="detailsModalLabel" style="color: #000000; font-weight: 700;">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#e03e3e" class="bi bi-card-list me-2" viewBox="0 0 16 16">
            <path d="M14.5 3a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1h9.5zm0 3a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1h9.5zm0 3a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1h9.5z"/>
            <circle cx="3" cy="3.5" r=".5"/>
            <circle cx="3" cy="6.5" r=".5"/>
            <circle cx="3" cy="9.5" r=".5"/>
          </svg>
          Detalii Notă
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Închide"></button>
      </div>
      <div class="modal-body" id="detailsModalBody" style="max-height: 60vh; overflow-y: auto; background-color: #fff; padding: 2rem; border-radius: 0 0 1rem 1rem; color: #222;">
        <!-- Datele vor fi injectate aici -->
      </div>
      <div class="modal-footer" style="border-top: 3px solid #e03e3e; background-color: #ffffff;">
        <button type="button" class="btn" data-bs-dismiss="modal" style="background-color: #e03e3e; color: white; font-weight: 600; border-radius: 0.5rem;">
          Închide
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Modal Editare -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border border-success">
      <div class="modal-header" >
        <h5 class="modal-title" style="color: red;" id="editModalLabel">Editează Înregistrarea</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Închide"></button>
      </div>
      <div class="modal-body">
        <form id="editForm" class="row g-3">
          <!-- câmpurile se vor adăuga dinamic -->
        </form>
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
        <button type="button" class="btn btn-success" onclick="submitEdit()">Salvează Modificările</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Fundal alb, contur fin roșu, text negru */
#editModal .modal-content {
  background-color: #fff;
  border: 2px solid #dc3545; /* roșu aprins */
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(220, 53, 69, 0.25);
  color: #222;
}

/* Header alb cu text roșu și subțire */
#editModal .modal-header {
  background-color: #fff;
  border-bottom: 2px solid #dc3545;
  color: #dc3545;
  font-weight: 600;
  font-size: 1.25rem;
}

/* Buton închidere negru */
#editModal .btn-close {
  filter: invert(20%) sepia(20%) saturate(400%) hue-rotate(0deg) brightness(50%) contrast(80%);
  /* negru moale */
}

/* Body alb cu text negru */
#editModal .modal-body {
  background-color: #fff;
  color: #222;
  font-size: 1rem;
  padding: 1.5rem 2rem;
}

/* Footer alb cu butoane stilizate */
#editModal .modal-footer {
  background-color: #fff;
  border-top: 2px solid #dc3545;
  padding: 1rem 2rem;
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
}

/* Buton anulare - bordură roșie, text roșu, hover fundal roșu cu text alb */
#editModal .btn-secondary {
  color: #dc3545;
  border: 2px solid #dc3545;
  background-color: transparent;
  font-weight: 600;
  padding: 0.4rem 1.2rem;
  border-radius: 6px;
  transition: all 0.25s ease;
}
#editModal .btn-secondary:hover {
  background-color: #dc3545;
  color: #fff;
  box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
}

/* Buton salvează - fundal roșu, text alb, hover fundal negru */
#editModal .btn-success {
  background-color: #dc3545;
  border: none;
  font-weight: 700;
  padding: 0.4rem 1.6rem;
  border-radius: 6px;
  transition: background-color 0.25s ease;
  box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4);
}
#editModal .btn-success:hover {
  background-color: #222;
  box-shadow: 0 4px 15px rgba(34, 34, 34, 0.7);
}

  #detailsModalBody table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 12px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 1rem;
  }

  #detailsModalBody table tr {
    background-color: #fefefe;
    box-shadow: 0 0 12px rgba(224, 62, 62, 0.3);
    border-radius: 14px;
    transition: background-color 0.3s ease;
  }

  #detailsModalBody table tr:hover {
    background-color: #ffe6e6;
  }

  #detailsModalBody table th {
    text-align: left;
    font-weight: 700;
    color: #000000; /* rosu */
    padding: 14px 20px;
    width: 35%;
    vertical-align: middle;
    border: none;
  }

  #detailsModalBody table td {
    padding: 14px 20px;
    vertical-align: middle;
    border: none;
    color: #222;
  }
  .is-invalid {
  border-color: #dc3545;
  background-color: #f8d7da;
}

</style>


  <!-- <div id="importStatus" style="display: none;">IMPORT STATUS</div> -->
  <!-- <script>

document.getElementById('mapareGLButton').addEventListener('click', function() {
        fetch('/start_mapare_gl', {method: 'POST'})
          .then(response => response.json())
          .then(data => {
              alert(data.message);
              if (data.task_id) {
                  checkTaskStatus(data.task_id); // poți folosi același polling ca la import
              }
          })
          .catch(error => {
              alert('Eroare la pornirea mapării GL!');
          });
    });

    function checkTaskStatus(taskId) {
    fetch(`/task_status/${taskId}`)
        .then(response => response.json())
        .then(data => {
            console.log('Task status:', data);
            let statusElement = document.getElementById('importStatus');
            
            if (data.state === 'SUCCESS') {
                if (data.result.status === 'success') {
                    statusElement.textContent = `Import completed successfully! ${data.result.message}`;
                } else {
                    statusElement.textContent = `Import failed: ${data.result.message}`;
                }
            } else if (data.state === 'PENDING') {
                statusElement.textContent = 'Import in progress...';
                setTimeout(() => checkTaskStatus(taskId), 2000);
            } else {
                statusElement.textContent = `Import failed: ${data.status}`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('importStatus').textContent = 'Error checking import status';
        });
}

  document.addEventListener('DOMContentLoaded', function() {
    const uploadButton = document.getElementById('uploadButton');
    const importButton = document.getElementById('importButton');
    const fileUpload = document.getElementById('fileUpload');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const uploadProgressBar = document.getElementById('uploadProgressBar');
    let uploadSuccessful = false;

    // Initially disable the upload and import buttons
    uploadButton.disabled = true;
    //importButton.disabled = true; //remove disabled

    fileUpload.addEventListener('change', function() {
        const file = fileUpload.files[0];

        if (file) {
            fileNameDisplay.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i> Fisier selectat: ${file.name}`;
            fileNameDisplay.style.display = "block";
            uploadButton.removeAttribute("disabled"); // Enable the upload button
        } else {
            fileNameDisplay.textContent = "";
            fileNameDisplay.style.display = "none";
            uploadButton.disabled = true; // Disable the upload button
            //importButton.disabled = true; // Disable the import button //remove disabled
            uploadSuccessful = false;
        }
    });

 uploadButton.addEventListener('click', function(event) {
    event.preventDefault(); // Prevent default form submission

    const file = fileUpload.files[0];

    if (file) {
        const formData = new FormData();
        formData.append('file', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/load_transform', true);

        // Set initial progress to 0
        uploadProgressBar.style.width = '0%';
        uploadProgressBar.textContent = '0%';
        uploadProgressBar.setAttribute('aria-valuenow', 0);

        // Upload progress event (doar progres local, nu confirmă succesul pe server)
        xhr.upload.addEventListener("progress", function(event) {
            if (event.lengthComputable) {
                const percentComplete = (event.loaded / event.total) * 100;
                // Bara se umple doar până la 99% până avem confirmarea de la server
                const safePercent = percentComplete >= 100 ? 99 : percentComplete;
                uploadProgressBar.style.width = safePercent + '%';
                uploadProgressBar.textContent = Math.floor(safePercent) + '%';
                uploadProgressBar.setAttribute('aria-valuenow', safePercent);
            }
        });

        // Request finished event
        xhr.addEventListener("load", function() {
            if (xhr.status === 200) {
                // Request successful
                uploadProgressBar.style.width = '100%';
                uploadProgressBar.textContent = '100%';
                uploadProgressBar.setAttribute('aria-valuenow', 100);
                uploadSuccessful = true;
                uploadButton.innerHTML = '<i class="fas fa-check-circle text-success me-1"></i> Uploaded';
                uploadButton.disabled = false;
            } else {
                // Request failed
                uploadProgressBar.style.width = '0%';
                uploadProgressBar.textContent = '0%';
                uploadProgressBar.setAttribute('aria-valuenow', 0);
                let errorMsg = 'File upload failed.';
                try {
                    const data = JSON.parse(xhr.responseText);
                    if (data.message) errorMsg += '\n' + data.message;
                } catch (e) {}
                alert(errorMsg);
                uploadSuccessful = false;
                uploadButton.innerHTML = 'Upload file';
            }
        });

        // Request error event
        xhr.addEventListener("error", function() {
            uploadProgressBar.style.width = '0%';
            uploadProgressBar.textContent = '0%';
            uploadProgressBar.setAttribute('aria-valuenow', 0);
            alert('File upload failed (network error).');
            uploadSuccessful = false;
            uploadButton.innerHTML = 'Upload file';
        });

        xhr.send(formData);
    } else {
        alert('Please select a file.');
        uploadProgressBar.style.width = '0%';
        uploadProgressBar.textContent = '0%';
        uploadProgressBar.setAttribute('aria-valuenow', 0);
    }
});
    importButton.addEventListener('click', function(event) {
        event.preventDefault(); // Prevent default form submission
        importButton.disabled = true; // dezactivează butonul imediat

        // Send request to import data
        const xhrImport = new XMLHttpRequest();
        xhrImport.open('POST', '/upload_into_database', true);

        xhrImport.addEventListener("load", function() {
            if (xhrImport.status === 200 || xhrImport.status === 202) {
                // Import successful, get task_id and start polling status
                const data = JSON.parse(xhrImport.responseText);
                if (data.task_id) {
                    document.getElementById('importStatus').textContent = 'Import started...';
                    checkTaskStatus(data.task_id);
                } else {
                    document.getElementById('importStatus').textContent = data.message || 'Import started, but no task_id returned.';
                }
            } else {
                // Import failed
                alert('File import failed.');
                console.error('Error:', xhrImport.status);
                importButton.disabled = false; // re-enable if error
            }
        });

        xhrImport.addEventListener("error", function() {
            alert('File import failed.');
            console.error('Error during the import.');
            importButton.disabled = false; // re-enable if error
        });

        xhrImport.send(); // No data needs to be sent, as the file is already on the server
    });

    const sectionNav = document.getElementById('sectionNav');
    if (sectionNav) {
      sectionNav.addEventListener('change', function() {
        const section = document.getElementById(this.value);
        if (section) {
          window.scrollTo({ top: section.offsetTop - 80, behavior: 'smooth' });
        }
      });
    }
  });
  
  
  </script> -->
  <!-- Footer -->
  

  <!-- Bootstrap JS and Popper.js -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>

  <!-- Custom JavaScript -->
   <script>
     const debitLei = document.getElementById('Amount');
  const debitValuta = document.getElementById('Foreign_Amount');
  const creditLei = document.getElementById('Credit_Amount');
  const creditValuta = document.getElementById('Credit_Foreign_Amount');

  function updateCreditFields() {
    creditLei.value = -parseFloat(debitLei.value || 0);
    creditValuta.value = -parseFloat(debitValuta.value || 0);
  }

  debitLei.addEventListener('input', updateCreditFields);
  debitValuta.addEventListener('input', updateCreditFields);
   
   
   
   
   
   document.addEventListener("DOMContentLoaded", function () {
  const fileInput = document.getElementById("fileUpload");
  const uploadBtn = document.getElementById("uploadButton");
  const importBtn = document.getElementById("importButton");
  const fileNameDisplay = document.getElementById("fileNameDisplay");
  const progressBar = document.getElementById("uploadProgressBar");

  // Când se selectează fișierul
  fileInput.addEventListener("change", () => {
    if (fileInput.files.length > 0) {
      uploadBtn.disabled = false;
      fileNameDisplay.style.display = "inline-block";
    } else {
      uploadBtn.disabled = true;
      fileNameDisplay.style.display = "none";
    }
  });

  // Upload fișier
  uploadBtn.addEventListener("click", async () => {
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("file", file);

    progressBar.style.width = "0%";
    progressBar.innerText = "0%";
    progressBar.classList.remove("bg-success", "bg-danger");

    try {
      const response = await fetch("/upload-gl", {
        method: "POST",
        body: formData
      });

      const result = await response.json();

      if (result.status === "ok") {
        progressBar.style.width = "100%";
        progressBar.innerText = "100%";
        progressBar.classList.add("bg-success");
        importBtn.disabled = false;
        showToast("Fișierul a fost încărcat cu succes.", "success");
      } else {
        progressBar.classList.add("bg-danger");
        showToast("Eroare la încărcare: " + result.message, "danger");
      }
    } catch (err) {
      progressBar.classList.add("bg-danger");
      showToast("Eroare la server: " + err.message, "danger");
    }
  });

  // Import în baza de date
  const importSpinner = document.getElementById("importSpinner");
  importBtn.addEventListener("click", async () => {
    importBtn.disabled = true;
  importSpinner.classList.remove("d-none");
    try {
      const response = await fetch("/import-gl", {
        method: "POST"
      });

      const result = await response.json();
      if (result.status === "ok" || result.status === "success") {
        showToast("Datele au fost importate cu succes în baza de date.", "success");
      } else {
        showToast("Eroare la import: " + result.message, "danger");
      }
    } catch (err) {
      showToast("Eroare la server: " + err.message, "danger");
    }
    finally {
    importSpinner.classList.add("d-none");
    importBtn.disabled = false;
  }
  });
});



 document.getElementById("mapareGLButton").addEventListener("click", async () => {
  const mapareBtn = document.getElementById("mapareGLButton");
  const mapareSpinner = document.getElementById("mapareSpinner");
  const periodeInput = document.getElementById("periodeInput").value;

  if (!periodeInput) {
    showToast("Vă rugăm să selectați o perioadă (YYYY-MM).", "danger");
    return;
  }

  const [yearStr, monthStr] = periodeInput.split("-");
  const year = parseInt(yearStr);
  const month = parseInt(monthStr);

  if (isNaN(year) || isNaN(month)) {
    showToast("Perioadă invalidă.", "danger");
    return;
  }

  mapareBtn.disabled = true;
  mapareSpinner.classList.remove("d-none");

  try {
    const response = await fetch("/mapare-gl-perioada", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ month, year })
    });

    const result = await response.json();

    if (result.status === "ok" || result.status === "success") {
      showToast(result.message || "Maparea s-a finalizat cu succes.", "success");
    } else {
      showToast(result.message || "Eroare la mapare.", "danger");
    }
  } catch (error) {
    showToast("Eroare la server: " + error.message, "danger");
  } finally {
    mapareSpinner.classList.add("d-none");
    mapareBtn.disabled = false;
  }
});


</script>
  <script>
      document.getElementById('previewButton').addEventListener('click', function () {
    const form = document.getElementById('entryForm');
    const inputs = form.querySelectorAll('input, select, textarea');
    
 let allFilled = true;

inputs.forEach(field => {
  const isEmpty = !field.value || field.value.trim() === '';

  if (isEmpty && field.hasAttribute('required')) {
    field.classList.add('is-invalid');
    allFilled = false;
  } else {
    field.classList.remove('is-invalid');
  }

  // Dacă vrei să marchezi neobligatorii gol cu alt stil, fără să blochezi:
  if (isEmpty && !field.hasAttribute('required')) {
    field.classList.add('border-warning', 'bg-light');
  } else {
    field.classList.remove('border-warning', 'bg-light');
  }
});

if (!allFilled) {
  showToast("Atentie! Nu au fost completate toate câmpurile obligatorii!", "warning");
  return;  // oprește execuția
}


    // Deschide modalul
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();

    // Previzualizare tabel
    const data = new FormData(form);
    let html = '<table class="table table-bordered"><tbody>';
    data.forEach((value, key) => {
      html += `<tr><th>${key}</th><td>${value ? value : '<i>necompletat</i>'}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('previewContent').innerHTML = html;
  });

  // Curăță evidențierea când utilizatorul scrie
  document.querySelectorAll('#entryForm input, #entryForm select').forEach(input => {
    input.addEventListener('input', () => {
      if (input.value && input.value.trim() !== '') {
        input.classList.remove('border-warning', 'bg-light');
      }
    });
  });
    // Selectăm butonul pentru previzualizare și modalul de previzualizare
document.addEventListener('DOMContentLoaded', function () {
  const previewModalEl = document.getElementById('previewModal');
  const previewModal = new bootstrap.Modal(previewModalEl);
  const saveButton = document.getElementById('savePreview');
  const form = document.getElementById('entryForm');
  const toastEl = document.getElementById('successToast');
  const toast = new bootstrap.Toast(toastEl);
  const toastMessageEl = document.getElementById('toastMessage');

  // const toast = new bootstrap.Toast(toastEl);

  saveButton.addEventListener('click', async () => {

  const dataToSend = {
    BR: document.getElementById('BR').value,
    File_Ref: document.getElementById('File_Ref').value,
    Statutory_GL_D: document.getElementById('Statutory_GL_D').value,  // cont debit
    Statutory_GL_C: document.getElementById('Statutory_GL_C').value,  // cont credit
    Journal: document.getElementById('Journal').value,
    Open_Item: document.getElementById('Open_Item').value,
    Date: document.getElementById('Date').value,
    Post_Date: document.getElementById('Post_Date').value,
    Month: document.getElementById('Month').value,
    Year: document.getElementById('Year').value,
    Amount: document.getElementById('Amount').value,
    Foreign_Amount: document.getElementById('Foreign_Amount').value,
    Credit_Amount: document.getElementById('Credit_Amount').value,  // suma credit lei
    Credit_Foreign_Amount: document.getElementById('Credit_Foreign_Amount').value,  // suma credit valută
    Currency: document.getElementById('Currency').value,
    data_Description: document.getElementById('data_Description').value,
    TC: document.getElementById('TC').value,
    Customer_GCI: document.getElementById('Customer_GCI').value,
    Customer_Name: document.getElementById('Customer_Name').value,
  };

  // Aici trimiți mai departe cu fetch/post


  try {
    const response = await fetch('/manual-nc', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dataToSend),
    });

    const responseData = await response.json();

    if (responseData.status === 'ok') {
      showToast(responseData.message, 'success');
      previewModal.hide();
      const previewModalInstance = bootstrap.Modal.getOrCreateInstance(previewModalEl);
previewModalInstance.hide();
//       const backdrop = document.querySelector('.modal-backdrop');
// if (backdrop) {
//   backdrop.remove();
//   document.body.classList.remove('modal-open');
//   document.body.style = ''; // în caz că stilul de scroll e blocat
// }
      form.reset();
      await generateJournalCode(); 
    } else {
      showToast(responseData.message || 'Eroare la salvare!', 'danger');
    }
  } catch (error) {
    showToast('Eroare la comunicarea cu serverul: ' + error.message, 'danger');
  }
});

  // Preview modal
  
  const previewButton = document.getElementById('previewButton');
  const inputs = form.querySelectorAll('input, select, textarea');
  previewButton.addEventListener('click', function () {
    let allFilled = true;

inputs.forEach(field => {
  const isEmpty = !field.value || field.value.trim() === '';

  if (isEmpty && field.hasAttribute('required')) {
    field.classList.add('is-invalid');
    allFilled = false;
  } else {
    field.classList.remove('is-invalid');
  }

  // Dacă vrei să marchezi neobligatorii gol cu alt stil, fără să blochezi:
  if (isEmpty && !field.hasAttribute('required')) {
    field.classList.add('border-warning', 'bg-light');
  } else {
    field.classList.remove('border-warning', 'bg-light');
  }
});

if (!allFilled) {
  showToast("Atentie! Nu au fost completate toate câmpurile obligatorii!", "warning");
  return;  // oprește execuția
}

    const previewContent = document.getElementById('previewContent');

    const BR = document.getElementById('BR').value;
const File_Ref = document.getElementById('File_Ref').value;
const Statutory_GL_D = document.getElementById('Statutory_GL_D').value;
const Statutory_GL_C = document.getElementById('Statutory_GL_C').value;
const Journal = document.getElementById('Journal').value;
const Open_Item = document.getElementById('Open_Item').value;
const DateDoc = document.getElementById('Date').value;
const Post_Date = document.getElementById('Post_Date').value;
const Month = document.getElementById('Month').value;
const Year = document.getElementById('Year').value;
const Amount = document.getElementById('Amount').value;
const Foreign_Amount = document.getElementById('Foreign_Amount').value;
const Credit_Amount = document.getElementById('Credit_Amount').value;
const Credit_Foreign_Amount = document.getElementById('Credit_Foreign_Amount').value;
const Currency = document.getElementById('Currency').value;
const data_Description = document.getElementById('data_Description').value;
const TC = document.getElementById('TC').value;
const Customer_GCI = document.getElementById('Customer_GCI').value;
const Customer_Name = document.getElementById('Customer_Name').value;

const previewHtml = `
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-6">
        <h5 style="color:red;" class="mb-3">Identificare Document</h5>
        <p><strong>BR:</strong> ${BR}</p>
        <p><strong>File Ref:</strong> ${File_Ref}</p>

        <h5 style="color:red;" class="mt-4 mb-3">Conturi</h5>
        <p><strong>Statutory GL Debit:</strong> ${Statutory_GL_D}</p>
        <p><strong>Statutory GL Credit:</strong> ${Statutory_GL_C}</p>
        <p><strong>Journal:</strong> ${Journal}</p>
        <p><strong>Open Item:</strong> ${Open_Item}</p>

        <h5 style="color:red;" class="mt-4 mb-3">Date Calendaristice</h5>
        <p><strong>Data Document:</strong> ${DateDoc}</p>
        <p><strong>Data Postare:</strong> ${Post_Date}</p>
      </div>

      <div class="col-md-6">
        <h5 style="color:red;" class="mb-3 mt-md-0">Date Calendaristice (continuare)</h5>
        <p><strong>Lună:</strong> ${Month}</p>
        <p><strong>An:</strong> ${Year}</p>

        <h5 style="color:red;" class="mt-4 mb-3">Valori & Devize</h5>
        <p><strong>Suma Debit (lei):</strong> ${Amount}</p>
        <p><strong>Suma Debit (valută):</strong> ${Foreign_Amount}</p>
        <p><strong>Suma Credit (lei):</strong> ${Credit_Amount}</p>
        <p><strong>Suma Credit (valută):</strong> ${Credit_Foreign_Amount}</p>
        <p><strong>Deviză:</strong> ${Currency}</p>

        <h5 style="color:red;" class="mt-4 mb-3">Descriere și Coduri</h5>
        <p><strong>Descriere:</strong> ${data_Description}</p>
        <p><strong>TC:</strong> ${TC}</p>

        <h5 style="color:red;" class="mt-4 mb-3">Date Client</h5>
        <p><strong>GCI:</strong> ${Customer_GCI}</p>
        <p><strong>Nume Client:</strong> ${Customer_Name}</p>
      </div>
    </div>
  </div>
`;


    previewContent.innerHTML = previewHtml;
    previewModal.show();
  });
});
  function toggleSection(sectionId) {
    // Obține toate secțiunile
    var sections = document.querySelectorAll('.card.mb-4');
    
    
    // Ascunde toate secțiunile
    sections.forEach(function(section) {
      section.style.display = 'none';
    });
    
    // Afișează secțiunea selectată
    var section = document.getElementById(sectionId);
    if (section) {
      section.style.display = 'block';
       // Scroll to the section
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }
function extractNotes() {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;

  if (!startDate || !endDate) {
    showToast('Introduceți perioada completă!', 'danger');
    return;
  }

  fetch('/get-notes', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ start_date: startDate, end_date: endDate })
  })
  .then(response => response.json())
  .then(result => {
    if (result.status === 'ok') {
      populateTable(result.data);
      showToast('Notele au fost extrase cu succes!', 'success');
    } else {
      showToast(result.message || 'Eroare necunoscută', 'danger');
    }
  })
  .catch(error => {
    console.error('Eroare la fetch:', error);
    showToast('A apărut o eroare la comunicarea cu serverul.', 'danger');
  });
}
function populateTable(data) {
  const table = document.getElementById('historical-table');
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');
  const pastelColors = [
    '#f8f9fa', '#f0f4ff', '#fef6f0', '#f2fff0', '#f9f0ff', 
    '#fffbe6', '#e6f7ff', '#f6ffed', '#fff0f6', '#f0f5ff'
  ];

  // Mapare: Acct_Tran_Id -> culoare
  const colorMap = new Map();
  let colorIndex = 0;

  // Golim thead și tbody
  thead.innerHTML = '';
  tbody.innerHTML = '';

  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="100%" class="text-center">Nicio notă găsită în perioada selectată.</td></tr>';
    return;
  }

  // Obținem toate coloanele din primul obiect (folosind for...in ca să păstrăm ordinea)
  const columns = [];
  for (const key in data[0]) {
    if (data[0].hasOwnProperty(key)) {
      columns.push(key);
    }
  }

  // Construim head-ul tabelului
  const trHead = document.createElement('tr');
  trHead.innerHTML = `<th>#</th>` + columns.map(col => `<th>${col}</th>`).join('') + `<th>Acțiuni</th>`;
  thead.appendChild(trHead);

  // Construim body-ul
  
  data.forEach((row, index) => {
    const tr = document.createElement('tr');
    const acctId = row['Acct_Tran_Id'];
    if (!colorMap.has(acctId)) {
      colorMap.set(acctId, pastelColors[colorIndex % pastelColors.length]);
      colorIndex++;
    }

    const bgColor = colorMap.get(acctId);
    tr.style.backgroundColor = bgColor;

    // Index
    let rowHtml = `<td>${index + 1}</td>`;

    // Coloane dinamice
    rowHtml += columns.map(col => {
      let val = row[col];
      if (val === null || val === undefined) val = '-';
      return `<td>${val}</td>`;
    }).join('');

    // Acțiuni (buton Detalii, Edit, Ștergere)
    rowHtml += `
      <td>
   <button 
  class="btn btn-sm me-1 btn-details" 
  style="
    color: #0d6efd;
    border: 1.5px solid #0d6efd;
    border-radius: 8px;
    font-weight: 600;
    padding: 6px 14px;
    background-color: white;
    box-shadow: 0 2px 6px rgba(13,110,253,0.1);
    transition: all 0.25s ease;
    cursor: pointer;
  "
  onmouseover="this.style.backgroundColor='#0d6efd'; this.style.color='white'; this.style.transform='translateY(-1px)';"
  onmouseout="this.style.backgroundColor='white'; this.style.color='#0d6efd'; this.style.transform='translateY(0)';"
>
  Detalii
</button>

<button 
  class="btn btn-sm me-1 btn-edit" 
  style="
    color: #198754;
    border: 1.5px solid #198754;
    border-radius: 8px;
    font-weight: 600;
    padding: 6px 14px;
    background-color: white;
    box-shadow: 0 2px 6px rgba(25,135,84,0.1);
    transition: all 0.25s ease;
    cursor: pointer;
  "
  onmouseover="this.style.backgroundColor='#198754'; this.style.color='white'; this.style.transform='translateY(-1px)';"
  onmouseout="this.style.backgroundColor='white'; this.style.color='#198754'; this.style.transform='translateY(0)';"
>
  Edit
</button>

<button 
  class="btn btn-sm btn-delete" 
  style="
    color: #dc3545;
    border: 1.5px solid #dc3545;
    border-radius: 8px;
    font-weight: 600;
    padding: 6px 14px;
    background-color: white;
    box-shadow: 0 2px 6px rgba(220,53,69,0.1);
    transition: all 0.25s ease;
    cursor: pointer;
  "
  onmouseover="this.style.backgroundColor='#dc3545'; this.style.color='white'; this.style.transform='translateY(-1px)';"
  onmouseout="this.style.backgroundColor='white'; this.style.color='#dc3545'; this.style.transform='translateY(0)';"
>
  Șterge
</button>


      </td>`;

    tr.innerHTML = rowHtml;
    tbody.appendChild(tr);

    // Event listener buton Detalii
    tr.querySelector('.btn-details').addEventListener('click', () => {
      showDetailsModal(row);
    });

    // Event listener buton Edit (aici poți pune ce funcționalitate vrei)
    tr.querySelector('.btn-edit').addEventListener('click', () => {
      // De exemplu, deschizi un modal de editare sau redirecționezi
      openEditModal(row);
    });

    // Event listener buton Ștergere (confirmare și acțiune)
    tr.querySelector('.btn-delete').addEventListener('click', () => {
      if (confirm('Ești sigur că vrei să ștergi această înregistrare?')) {
        deleteRecord(row);
      }
    });
  });
}

// Exemplu funcții pentru edit și delete (trebuie să le implementezi tu după nevoi)
function openEditModal(row) {
  console.log('Edit:', row);
  // deschide modal, populare câmpuri etc.
}

function showToast(message, type = 'success') {
  const toastContainer = document.getElementById('toastContainer');
  if (!toastContainer) return;

  const toastEl = document.createElement('div');
  toastEl.className = `toast align-items-center text-bg-${type} border-0`;
  toastEl.role = 'alert';
  toastEl.ariaLive = 'assertive';
  toastEl.ariaAtomic = 'true';
  toastEl.style.minWidth = '200px';

  toastEl.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Închide"></button>
    </div>
  `;

  toastContainer.appendChild(toastEl);
  const bsToast = new bootstrap.Toast(toastEl);
  bsToast.show();

  toastEl.addEventListener('hidden.bs.toast', () => {
    toastEl.remove();
  });
}

function deleteRecord(row) {
  if (!row.id) {
    showToast('ID-ul înregistrării este invalid!', 'danger');
    return;
  }

  fetch('/delete-note', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id: row.id })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'ok') {
      showToast('Înregistrarea a fost ștearsă cu succes!');
      extractNotes(); // funcția ta de refresh tabel
    } else {
      showToast('Eroare la ștergere: ' + data.message, 'danger');
    }
  })
  .catch(err => {
    console.error('Eroare la fetch:', err);
    showToast('A apărut o eroare la ștergere.', 'danger');
  });
}

// Funcția care afișează modalul cu detalii frumos formatate
function showDetailsModal(rowData) {
  const modalBody = document.getElementById('detailsModalBody');
  modalBody.innerHTML = ''; // reset

  // Construim un tabel cu datele
  const table = document.createElement('table');
  table.className = 'table table-bordered';

  for (const key in rowData) {
    if (rowData.hasOwnProperty(key)) {
      const tr = document.createElement('tr');

      const th = document.createElement('th');
      th.style.width = '30%';
      th.textContent = key;

      const td = document.createElement('td');
      td.textContent = rowData[key] === null ? '-' : rowData[key];

      tr.appendChild(th);
      tr.appendChild(td);
      table.appendChild(tr);
    }
  }

  modalBody.appendChild(table);

  // Deschidem modalul (folosind Bootstrap 5)
  const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
  detailsModal.show();
}

 $(document).ready(function () {
  $('#map-table').DataTable({
  dom: 'Bfrtip',
  buttons: [
    {
      extend: 'csv',
      text: '📄 CSV',
      className: 'btn btn-outline-primary me-2',
      messageTop: 'Export generat automat pe baza maparii curente.',
messageBottom: 'Generat de aplicația GT',
title: 'Mapare conturi GL',
sheetName: 'Export_GL',
      filename: 'Mapare_GL_' + new Date().toISOString().slice(0, 10),
      exportOptions: {
        columns: ':not(:last-child)' // Exclude last column (Actions)
      }
    },
    {
      extend: 'excel',
      text: '📊 Excel',
      className: 'btn btn-success',
      sheetName: 'Export_GL',
      title: 'Mapare conturi GL',
      messageTop: 'Export generat automat pe baza maparii curente.',
messageBottom: 'Generat de aplicația GT',

      filename: 'Mapare_GL_' + new Date().toISOString().slice(0, 10),
      exportOptions: {
        columns: ':not(:last-child)' // Exclude last column (Actions)
      }
    }
  ],
  pageLength: 10,
  lengthMenu: [5, 10, 25, 50, 100],
  language: {
    search: "Căutare:",
    lengthMenu: "Afișează _MENU_ înregistrări",
    info: "Afișează _START_ - _END_ din _TOTAL_",
    paginate: {
      next: "Următorul",
      previous: "Înapoi"
    },
    zeroRecords: "Nicio înregistrare găsită",
  }
});

  });
  // Funcția pentru editarea unei note contabile
  function editNote(index) {
    alert("Editare pentru nota contabila cu indexul: " + index);
    // Aici poți deschide un formular pentru editarea notei contabile
  }
  document.addEventListener("DOMContentLoaded", function () {
      // Dropdown pentru Utilizatori
      let usersDropdown = document.getElementById("usersDropdown");
  
      if (usersDropdown) {
        usersDropdown.addEventListener("mouseenter", function () {
          let menu = this.querySelector(".dropdown-menu");
          menu.classList.add("show");  // Afișează dropdown-ul
        });
  
        usersDropdown.addEventListener("mouseleave", function () {
          let menu = this.querySelector(".dropdown-menu");
          menu.classList.remove("show");  // Ascunde dropdown-ul
        });
      }
  
      // Dropdown pentru Utilizator Autentificat
      let userDropdown = document.getElementById("userDropdown");
  
      if (userDropdown) {
        userDropdown.addEventListener("mouseenter", function () {
          let menu = this.querySelector(".dropdown-menu");
          menu.classList.add("show");  // Afișează dropdown-ul
        });
  
        userDropdown.addEventListener("mouseleave", function () {
          let menu = this.querySelector(".dropdown-menu");
          menu.classList.remove("show");  // Ascunde dropdown-ul
        });
      }
    });






 function deleteRow(button) {
    const row = $(button).closest('tr');
    const headers = [];

    row.find('td').each(function(index) {
      const colName = $('#map-table thead th').eq(index).text().trim();
      const colValue = $(this).text().trim();

      if (colName && colName !== 'Acțiuni') {
        headers.push({ key: colName, value: colValue });
      }
    });

    const payload = {};
    headers.forEach(item => {
      payload[item.key] = item.value;
    });

    if (!confirm("Ești sigur că vrei să ștergi acest rând?")) return;

    $.ajax({
      url: '/delete_map',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(payload),
      success: function () {
        alert("Șters cu succes!");
        row.remove();
      },
      error: function (xhr) {
        alert("Eroare la ștergere: " + xhr.responseText);
      }
    });
  }
const sidebar = document.getElementById('historySidebar');
const sidebarLabel = sidebar.querySelector('.sidebar-label');
const closeBtn = document.getElementById('closeHistoryBtn');
closeBtn.addEventListener('click', (e) => {
  e.stopPropagation();  // previne propagarea evenimentului
  sidebar.classList.remove('expanded');
});

// Click pe bara minimizată extinde sidebar-ul
sidebarLabel.addEventListener('click', (e) => {
  e.stopPropagation(); // previne propagarea
  sidebar.classList.add('expanded');
});

// Click pe document închide sidebar-ul dacă click-ul nu e în interior
document.addEventListener('click', (e) => {
  if (!sidebar.contains(e.target)) {
    sidebar.classList.remove('expanded');
  }
});

// Click în interiorul sidebar-ului previne închiderea (oprește propagarea)
sidebar.addEventListener('click', (e) => {
  e.stopPropagation();
});
window.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.getElementById('historySidebar');

    // Deschidere automată cu întârziere de 600ms
   setTimeout(() => {
    sidebar.classList.add('expanded');

    // Strângere automată după 5 secunde de la deschidere
    setTimeout(() => {
      sidebar.classList.remove('expanded');
    }, 1500);

  }, 400);
    // Închidere la clic pe „×”
    document.getElementById('closeHistoryBtn').addEventListener('click', () => {
      sidebar.classList.remove('expanded');
    });

    // (Opțional) click pe bara laterală redeschide
    sidebar.addEventListener('click', () => {
      if (!sidebar.classList.contains('expanded')) {
        sidebar.classList.add('expanded');
      }
    });
  });

// function getRowData(row) {
//     const cells = row.querySelectorAll('td');
//     const headers = [...document.querySelectorAll('#map-table thead th')].map(h => h.innerText);
//     headers.pop(); // remove "Acțiuni"
//     const data = {};

//     cells.forEach((cell, i) => {
//       if (i < headers.length) {
//         data[headers[i]] = cell.innerText.trim();
//       }
//     });

//     return data;
//   }

//   // function editRow(btn) {
//   //   const row = btn.closest('tr');
//   //   const id = row.dataset.id;
//   //   const data = getRowData(row);

//   //   fetch(`/edit_map/${id}`, {
//   //     method: 'POST',
//   //     headers: { 'Content-Type': 'application/json' },
//   //     body: JSON.stringify(data)
//   //   }).then(r => {
//   //     if (r.ok) alert("Rând actualizat.");
//   //     else alert("Eroare la actualizare.");
//   //   });
//   // }


//   function addEmptyRow() {
//     const table = document.querySelector('#map-table tbody');
//     const headers = document.querySelectorAll('#map-table thead th');
//     const newRow = document.createElement('tr');

//     headers.forEach((th, i) => {
//       const td = document.createElement('td');
//       td.contentEditable = i !== headers.length - 1;
//       td.innerText = '';
//       newRow.appendChild(td);
//     });

//     const actionTd = newRow.lastChild;
//     actionTd.innerHTML = `
//       <button class="btn btn-primary btn-sm" onclick="addRow(this)">Adaugă</button>
//     `;

//     table.appendChild(newRow);
//   }

//   function addRow(btn) {
//     const row = btn.closest('tr');
//     const data = getRowData(row);

//     fetch('/add_map', {
//       method: 'POST',
//       headers: { 'Content-Type': 'application/json' },
//       body: JSON.stringify(data)
//     }).then(r => {
//       if (r.ok) {
//         alert("Rând adăugat.");
//         location.reload(); // sau doar actualizezi ID-ul, dacă vrei
//       } else {
//         alert("Eroare la adăugare.");
//       }
//     });
//   }

    
  </script>
  <script>
  $(document).ready(function () {
    

    $('#addRowBtn').click(function () {
      const headers = {{ map_df[0].keys()|list|tojson }};
      let newRow = '';
      headers.forEach(key => {
        if (key === 'ID') {
          newRow += '<td></td>';
        } else {
          newRow += `<td contenteditable="true"></td>`;
        }
      });
      newRow += `<td>
                  <button class="btn btn-outline-success btn-sm" onclick="saveRow(this)">Salvează</button>
                </td>`;
      $('#map-table tbody').prepend(`<tr>${newRow}</tr>`);
    });
  });

  function saveRow(button) {
    const row = $(button).closest('tr');
    const cells = row.find('td').toArray();
    const data = {
      'GL': $(cells[0]).text().trim(),
      'Br': $(cells[1]).text().trim(),
      'Statutory_GL': $(cells[2]).text().trim(),
      'Statutory_Type': $(cells[3]).text().trim(),
      'Transaction_Type': $(cells[4]).text().trim(),
      'Headers': $(cells[5]).text().trim()
    };

    $.ajax({
      url: '/add_map',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(data),
      success: function (response) {
        alert('Rând adăugat cu succes!');
        location.reload();  // reîncarcă pentru a vedea noul ID
      },
      error: function (xhr) {
        alert('Eroare la salvare: ' + xhr.responseText);
      }
    });
  }

  // function deleteRow(button) {
  //   const row = button.closest('tr');
  //   const table = $('#map-table').DataTable();
  //   table.row(row).remove().draw();
  // }
  document.getElementById("soldCLButton").addEventListener("click", function () {
    const perioada = document.getElementById("periodeInputClienti").value;
    const msgDiv = document.getElementById("soldClientiMsg");
    const button = this;

    if (!perioada) {
        alert("Introduceți perioada!");
        return;
    }
    

    // Arătăm mesajul de încărcare cu spinner
    msgDiv.style.display = 'block';
    msgDiv.className = '';
    msgDiv.innerHTML = '<span class="spinner"></span> Se procesează... Vă rugăm așteptați.';

    // Dezactivăm butonul
    button.disabled = true;

    const [year, month] = perioada.split("-");
    const formData = new FormData();
    formData.append("start-dateCl", `${year}-${month}`);
    formData.append("end-dateCl", `${year}-${month}`);

    fetch("/genereaza_sold_clienti", {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        msgDiv.classList.remove('text-danger', 'text-success');

        if (data.status === "success") {
            msgDiv.classList.add('text-success');
            msgDiv.textContent = "Sold clienți generat cu succes!";
        } else if (data.status === "already_exists") {
            msgDiv.classList.add('text-danger');
            msgDiv.textContent = "Datele pentru această perioadă au fost deja importate și sunt identice.";
        } else if (data.status === "no_data") {
            msgDiv.classList.add('text-danger');
            msgDiv.textContent = "Nu s-au găsit date pentru perioada selectată. Vă rugăm să importați GL pentru această perioadă.";
        } else {
            msgDiv.classList.add('text-danger');
            msgDiv.textContent = "A apărut o eroare neașteptată.";
        }
    })
    .catch(error => {
        msgDiv.classList.remove('text-success');
        msgDiv.classList.add('text-danger');
        msgDiv.textContent = "Eroare la generare: " + error.message;
    })
    .finally(() => {
        button.disabled = false;
    });
});
 
document.getElementById("soldFzButton").addEventListener("click", function () {
    const perioada = document.getElementById("periodeInputFurnizori").value;
    const msgDiv = document.getElementById("soldFurnizoriMsg");
    const button = this;

    if (!perioada) {
        alert("Introduceți perioada!");
        return;
    }

    // Arătăm mesajul de încărcare cu spinner
    msgDiv.style.display = 'block';
    msgDiv.className = '';
    msgDiv.innerHTML = '<span class="spinner"></span> Se procesează... Vă rugăm așteptați.';

    // Dezactivăm butonul
    button.disabled = true;

    const [year, month] = perioada.split("-");
    const formData = new FormData();
    formData.append("start-dateFz", `${year}-${month}`);
    formData.append("end-dateFz", `${year}-${month}`);

    fetch("/genereaza_sold_furnizori", {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        msgDiv.classList.remove('text-danger', 'text-success');

        if (data.status === "success") {
            msgDiv.classList.add('text-success');
            msgDiv.textContent = "Sold furnizori generat cu succes!";
        } else if (data.status === "already_exists") {
            msgDiv.classList.add('text-danger');
            msgDiv.textContent = "Datele pentru această perioadă au fost deja importate și sunt identice.";
        } else if (data.status === "no_data") {
            msgDiv.classList.add('text-danger');
            msgDiv.textContent = "Nu s-au găsit date pentru perioada selectată. Vă rugăm să importați GL pentru această perioadă.";
        } else {
            msgDiv.classList.add('text-danger');
            msgDiv.textContent = "A apărut o eroare neașteptată.";
        }
    })
    .catch(error => {
        msgDiv.classList.remove('text-success');
        msgDiv.classList.add('text-danger');
        msgDiv.textContent = "Eroare la generare: " + error.message;
    })
    .finally(() => {
        button.disabled = false;
    });
});
 const fileInput = document.getElementById("nc-file-upload");
  const uploadBtn = document.getElementById("nc-upload-button");
  const importBtn = document.getElementById("nc-import-button");
  const fileNameDisplay = document.getElementById("nc-file-name-display");
  const progressBar = document.getElementById("nc-upload-progress-bar");

  // Când se selectează fișierul
  fileInput.addEventListener("change", () => {
    if (fileInput.files.length > 0) {
      uploadBtn.disabled = false;
      fileNameDisplay.style.display = "inline-block";
    } else {
      uploadBtn.disabled = true;
      fileNameDisplay.style.display = "none";
    }
  });

  // Upload fișier
  uploadBtn.addEventListener("click", async () => {
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("file", file);

    progressBar.style.width = "0%";
    progressBar.innerText = "0%";

    try {
      const response = await fetch("/upload-nc", {
        method: "POST",
        body: formData
      });

      const result = await response.json();

      if (result.status === "ok") {
        progressBar.style.width = "100%";
        progressBar.innerText = "100%";
        progressBar.classList.add("bg-success");
        importBtn.disabled = false;
          showToast("Fișierul a fost încărcat cu succes.", "success");
      } else {
        progressBar.classList.add("bg-danger");
        showToast("Eroare la import: " + result.message, "danger");
      }
    } catch (err) {
      showToast("Eroare la server: " + err.message, "danger");
    }
  });

  // Import în baza de date
  importBtn.addEventListener("click", async () => {
    try {
      const response = await fetch("/import-nc-gl", {
        method: "POST"
      });

      const result = await response.json();
      if (result.status === "ok") {
         showToast("Datele au fost importate cu succes în GL in baza de date.", "success");
      } else {
        showToast("Eroare la import: " + result.message, "danger");
      }
    } catch (err) {
      showToast("Eroare la server: " + err.message, "danger");
    }
  });
//   function showToast(message, type = 'success') {
//   const toastEl = document.getElementById('liveToast');
//   const toastMsg = document.getElementById('toastMessage');

//   toastEl.className = `toast text-white bg-${type}`;
//   toastMsg.textContent = message;

//   const toast = new bootstrap.Toast(toastEl);
//   toast.show();
// }

let currentEditRow = null;

function openEditModal(row) {
  currentEditRow = row; // ținem minte rândul care se editează
  const form = document.getElementById('editForm');
  form.innerHTML = '';

  for (const key in row) {
    let val = row[key] ?? '';
    let inputType = 'text';  // tipul implicit de input
    let readonlyAttr = '';

    // Facem anumite câmpuri readonly
    const readonlyFields = ['id', 'JT', 'user','rowNumber','User_id','User_name','User_email','Acct_Tran_Id'];
    if (readonlyFields.includes(key)) {
      readonlyAttr = 'readonly';
    }

    // Detectăm câmpurile de tip dată după nume (poți ajusta lista după cum ai nevoie)
    const dateFieldsPatterns = ['date', 'Date', 'timestamp', 'Data'];
    if (dateFieldsPatterns.some(pattern => key.includes(pattern))) {
      inputType = 'date';

      // Pentru a pune valoarea în format compatibil input date
      // Dacă val nu e gol și e string, îl convertim în format YYYY-MM-DD
      if (val) {
        // Dacă val este deja în format 'YYYY-MM-DD', îl lăsăm așa, altfel încercăm să extragem partea relevantă
        if (!/^\d{4}-\d{2}-\d{2}$/.test(val)) {
          val = val.slice(0, 10);  // primele 10 caractere ar trebui să fie YYYY-MM-DD
        }
      }
    }

    const field = document.createElement('div');
    field.className = 'col-md-6';

    field.innerHTML = `
      <label class="form-label">${key}</label>
      <input type="${inputType}" class="form-control" name="${key}" value="${val}" ${readonlyAttr}>
    `;

    form.appendChild(field);
  }

  // Deschide modalul
  const modal = new bootstrap.Modal(document.getElementById('editModal'));
  modal.show();
}

function submitEdit() {
  const form = document.getElementById('editForm');
  const formData = new FormData(form);
  const data = {};

  for (const [key, value] of formData.entries()) {
    data[key] = value;
  }

  fetch('/update-note', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
    .then(res => res.json())
    .then(response => {
      if (response.status === 'ok') {
        showToast('Modificările au fost salvate cu succes!', 'success');
        const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
        modal.hide();
        extractNotes(); // sau loadDataAndPopulateTable() dacă folosești acea funcție
      } else {
        showToast('Eroare: ' + response.message, 'danger');
      }
    })
    .catch(err => {
      showToast('Eroare rețea: ' + err, 'danger');
    });
}

document.getElementById('deleteGLButton').addEventListener('click', async function () {
  const perioada = document.getElementById('deleteGLPerioadaInput').value;
  const spinner = document.getElementById('deleteGLSpinner');
  const feedback = document.getElementById('deleteGLFeedback');

  if (!perioada) {
    alert('Te rog să introduci o perioadă (YYYY-MM).');
    return;
  }

  // Afișează spinner
  spinner.classList.remove('d-none');
  feedback.classList.add('d-none');

  try {
    const response = await fetch(`/delete-gl?perioada=${encodeURIComponent(perioada)}`, {
      method: 'DELETE'
    });

    if (response.ok) {
      const result = await response.json();
      feedback.textContent = result.message || "GL șters cu succes.";
      feedback.classList.remove('d-none', 'text-danger');
      feedback.classList.add('text-success');
    } else {
      let errorMsg;
      try {
        const errJson = await response.json();
        errorMsg = errJson.message || JSON.stringify(errJson);
      } catch {
        errorMsg = await response.text();
      }
      feedback.textContent = `Eroare: ${errorMsg}`;
      feedback.classList.remove('d-none', 'text-success');
      feedback.classList.add('text-danger');
    }
  } catch (err) {
    feedback.textContent = `Eroare de rețea: ${err.message}`;
    feedback.classList.remove('d-none', 'text-success');
    feedback.classList.add('text-danger');
  } finally {
    spinner.classList.add('d-none');
  }
});
function pad(num, size) {
    let s = num + "";
    while (s.length < size) s = "0" + s;
    return s;
}

async function generateJournalCode() {
    const journalInput = document.getElementById('Journal');
    if (!journalInput) return;

    // Folosește data curentă
    const d = new Date();
    const year = d.getFullYear();
    const yy = String(year).slice(-2);
    const mm = pad(d.getMonth() + 1, 2);
    const dd = pad(d.getDate(), 2);
    const dateStr = `${year}-${mm}-${dd}`;

    // Ia numărul secvențial de la server
    let seq = 1;
    try {
        const resp = await fetch(`/get-journal-seq?date=${dateStr}`);
        if (resp.ok) {
            const data = await resp.json();
            seq = data.seq || 1;
        }
    } catch (e) {}

    const nnn = pad(seq, 3);
    journalInput.value = `EE${yy}${mm}${dd}${nnn}`;
}
document.addEventListener('DOMContentLoaded', generateJournalCode);
document.querySelectorAll('#entryForm input, #entryForm select, #entryForm textarea').forEach(input => {
  input.addEventListener('input', () => {
    if (input.value && input.value.trim() !== '') {
      input.classList.remove('is-invalid');
    }
  });
});
// Sau când deschizi secțiunea manual-NC, apelează generateJournalCode();
</script>

</body>
</html>
