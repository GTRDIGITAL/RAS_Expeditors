<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Contabilitate</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <!-- Icone FontAwesome pentru Navbar -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
      #dropdown-container {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    max-width: 600px;
  }

  /* Etichetele (label) mai vizibile */
  #dropdown-container label {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 6px;
    display: inline-block;
    color: #343a40;
  }

  /* Spacing între cele două select-uri */
  #dropdown-container select {
    margin-bottom: 12px;
  }

  /* Select2 custom theme */
  .select2-container--default .select2-selection--multiple {
    border: 1px solid #ced4da;
    border-radius: 8px;
    padding: 4px 8px;
    min-height: 42px;
    background-color: #fff;
    transition: all 0.2s ease;
  }

  .select2-container--default.select2-container--focus .select2-selection--multiple {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }

  .select2-container--default .select2-selection--multiple .select2-selection__choice {
    background-color: #0d6efd;
    border: none;
    color: #fff;
    padding: 2px 8px;
    margin-top: 4px;
    border-radius: 6px;
    font-size: 0.85rem;
  }

  /* Placeholder color */
  .select2-container--default .select2-selection--multiple .select2-search__field::placeholder {
    color: #adb5bd;
  }

  /* Responsive */
  @media (max-width: 576px) {
    #dropdown-container {
      padding: 15px;
    }
    #dropdown-container label {
      font-size: 0.95rem;
    }
  }

  #dropdown-container {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    max-width: 600px;
  }

  .form-check-label {
    font-weight: 600;
  }

  .btn {
    min-width: 180px;
  }

  .select2-selection__choice {
    background-color: #0d6efd !important;
    color: white !important;
  }


    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, rgb(0, 0, 0) 30%, rgba(114, 2, 2, 0.864) 50%, rgb(0, 0, 0) 60%);
      color: #333;
      margin: 0;
      padding: 0;
      background-size: cover;
      background-attachment: fixed;
    }

    .navbar {
      background-color: #000;
    }

    .navbar-brand {
      color: #fff;
    }

    .navbar-nav .nav-link {
      color: #fff;
    }

    .navbar-nav .nav-link:hover {
      background-color: #e74c3c;
    }

    .container {
      margin-top: 120px;
      padding: 30px;
    }

    .card {
      background-color: #ecf0f1;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.6);
    }

    .card-header {
      background-color: #010101;
      color: #fff;
      font-size: 1.25rem;
      font-weight: 500;
      border-radius: 30px;
      margin-top: 20px;
    }

    .card-body {
      background-color: #ecf0f1;
      color: #333;
      height: fit-content;
    }

    .btn {
      border-radius: 25px;
      padding: 10px 25px;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }

    .btn-primary {
      background-color: #e74c3c;
    }

    .btn-primary:hover {
      background-color: #c0392b;
    }

    .footer {
      text-align: center;
      padding: 20px;
      background-color: black;
      position: fixed;
      width: 100%;
      bottom: 0;
      color: #fff;
    }

    /* Sticky header for tables */
    .table thead th {
      position: sticky;
      top: 0;
      z-index: 1;
      background-color: #010101;
      color: white;
    }
    
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #333;
      color: #fff;
      padding: 15px 0;
      text-align: center;
    }

    .logo-img {
      width: 180px;
      height: 90px;
    }

    /* Scrollable table */
    .table-responsive {
      max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.1);
    }

    /* Dropdown filter styles */
    .filterable {
      position: relative;
      z-index: 10;
    }
    .dropdown-menu {
  position: fixed; /* Plasăm dropdown-ul peste tot */
  width: 250px;
  max-height: 250px;
  overflow-y: auto; /* Scroll doar pe dropdown */
  background-color: #fff;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  z-index: 1000;
  padding: 8px 0;
  box-sizing: border-box;
  border: 1px solid #ddd;
}

.filter-search input {
  width: 90%;
  padding: 8px;
  margin: 8px auto;
  display: block;
  border-radius: 5px;
  border: 1px solid #ddd;
}

.dropdown-item {
  padding: 8px 16px;
  cursor: pointer;
  border-bottom: 1px solid #f1f1f1;
  transition: background-color 0.2s ease;
}

.dropdown-item input[type="checkbox"] {
  margin-right: 8px;
}

.dropdown-item:hover {
  background-color: #f9f9f9;
}
/* Stilizare Dropdown */
.dropdown-menu {
  background-color: white;
  border: 2px solid #ddd; /* Bordură subtilă */
  border-radius: 8px; /* Colțuri rotunjite */
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Efect de umbră pentru adâncire */
  position: absolute;
  z-index: 999;
  width: 200px; /* Lățime fixă */
  max-height: 300px; /* Înălțime limitată pentru a evita overflow-ul */
  overflow-y: auto; /* Scroll pe verticală */
  transition: all 0.2s ease-in-out;
}

/* Hover pe dropdown */
.dropdown-menu:hover {
  box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15); /* Umbră mai mare la hover */
}

/* Input de căutare */
.filter-search {
  margin: 8px;
  padding: 5px;
}

.filter-search input {
  width: calc(100% - 10px);
  padding: 6px 10px;
  border-radius: 4px;
  border: 1px solid #ddd;
  outline: none;
  transition: border 0.2s ease-in-out;
  font-size: 14px;
}

/* Când input-ul de căutare e în focus */
.filter-search input:focus {
  border-color: #4CAF50;
}

/* Dropdown items */
.dropdown-item {
  padding: 10px 12px;
  font-size: 14px;
  display: flex;
  
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* Hover pe itemele din dropdown */
.dropdown-item:hover {
  background-color: #f1f1f1; /* Fundal ușor gri la hover */
  color: #388E3C; /* Culoare verde pentru text */
}

/* Stilizare pentru "Selectează toate" */
.select-all {
  font-weight: bold;
  padding: 10px 12px;
  background-color: #dedbdb;
  border-top: 1px solid #ddd;
  transition: background-color 0.3s ease;
}

/* Hover pe "Selectează toate" */
.select-all:hover {
  background-color: #f0f0f0;
}

/* Input pentru checkboxuri - Stilit unitar cu dropdown */
input[type="checkbox"] {
  appearance: none;
  width: 18px;
  height: 18px;
  border: 2px solid #4CAF50;  /* Verde */
  border-radius: 4px;
  position: relative;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

/* Când checkbox-ul e selectat */
input[type="checkbox"]:checked {
  background-color: #4CAF50;
  border-color: #4CAF50;
}

/* Bifa la checkbox */
input[type="checkbox"]::after {
  content: "✔";
  font-size: 14px;
  color: white;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: none;
}

/* Afișează bifa când checkbox-ul este selectat */
input[type="checkbox"]:checked::after {
  display: block;
}

/* Input text pentru căutare */
.filter-search input {
  border-radius: 4px;
  padding: 8px 12px;
  width: 100%;
  border: 1px solid #ddd;
  font-size: 14px;
  outline: none;
}
/* Flash message styling */
.alert {
  padding: 15px 20px;
  border-radius: 10px;
  border: none;
  font-weight: 500;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.95rem;
}

.alert-success {
  background-color: #e6f9ed;
  color: #267d49;
}

.alert-warning {
  background-color: #fff9e6;
  color: #b08900;
}

.alert-danger {
  background-color: #fbeaea;
  color: #a94442;
}

.alert-primary {
  background-color: #e7f0ff;
  color: #004085;
}

.alert .btn-close {
  margin-left: auto;
  background: none;
  border: none;
  font-size: 1.2rem;
  color: inherit;
  opacity: 0.6;
  transition: opacity 0.3s;
}

.alert .btn-close:hover {
  opacity: 1;
  cursor: pointer;
}

/* Când input-ul de căutare e activ */
.filter-search input:focus {
  border-color: #4CAF50;
  box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); /* Efect de focus */
}

.clear-filter {
  display: flex;
  justify-content: center;
  margin-bottom: 8px;
}

.clear-filter button {
  background: #ff4d4d;
  color: white;
  border: none;
  padding: 6px 12px;
  font-size: 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.3s ease;
}

.clear-filter button:hover {
  background: #cc0000;
  color:white;
}
  </style>
</head>
<body>


  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('views.main', email=session['email']) }}">
        <img src="static/unnamed.jpg" alt="Logo" class="logo-img">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('views.main', email=session['email']) }}">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('views.generate_reports', email=session['email']) }}">Generare Raport</a>
          </li>
           <li class="nav-item">
            <a class="nav-link" href="{{ url_for('views.generate_monthlyTB', email=session['email']) }}">Generare Monthly TB</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('views.load_transform', email=session['email']) }}">Transformă & Încarcă GL</a>
          </li>
          <li class="nav-item dropdown" id="userDropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button">
              <i class="fas fa-user"></i> <span id="username">{{user_name}}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
               <li><a class="dropdown-item" href="{{ url_for('auth.change_password', email=session['email']) }}"><i class="fas fa-key"></i> Change Password</a></li>
              <li><a class="dropdown-item" href="{{ url_for('auth.login', email=session['email']) }}"><i class="fas fa-sign-out-alt"></i> Sign Out</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mt-5 pt-5">
    <!-- Filters for period -->

    <div class="card">
      <div class="card-header">
        Filtru Perioadă

      </div>
      <div class="card-body">
                     {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">&times;</button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}
<div class="card border-0 shadow-lg p-4 mb-5 rounded-4">
  <div class="mb-4">
    <h4 class="text-black fw-bold mb-1">Generare Rapoarte Contabile</h4>
    <p class="text-muted">Selectează perioada și generează raportul dorit</p>
  </div>
 <div id="dropdown-container" class="mt-4" style="display: none;">
  <!-- Checkbox + Select cont 6 -->
   <form method="POST" id="fisaForm">
  <div class="form-check mb-3">
  <div class="text-center mb-4">
 <div class="d-inline-block px-4 py-2 rounded-3 border shadow-sm bg-light">
      <span class="text-muted">Perioadă selectată:</span><br>

      <input type="text" 
             id="start-date-fisa" 
             name="start-date" 
             readonly 
             class="border-0 bg-transparent text-dark fw-semibold text-center" 
             style="width: 140px;" 
             value="-">

      <span class="mx-2 text-muted">→</span>

      <input type="text" 
             id="end-date-fisa" 
             name="end-date" 
             readonly 
             class="border-0 bg-transparent text-dark fw-semibold text-center" 
             style="width: 140px;" 
             value="-">
    </div>
</div>


    <input class="form-check-input" type="checkbox" value="" id="checkCont6">
    <label class="form-check-label" for="checkCont6">Fișa Conturi de 6</label>
  </div>
  
    
  <div class="mb-3" id="selectCont6" style="display: none;">
    <label for="conturi6">Conturi de 6:</label>
    <select id="conturi6" name="conturi6[]" class="form-select" multiple>
      <option value="select_all">🔘 Selectează toate</option>
      {% for item in values_6 %}
      <option value="{{ item.GL }}">{{ item.GL }}</option>
    {% endfor %}
    </select>
  </div>

  <!-- Checkbox + Select cont 7 -->
  <div class="form-check mb-3">
    
    <input class="form-check-input" type="checkbox" value="" id="checkCont7">
    <label class="form-check-label" for="checkCont7">Fișa Conturi de 7</label>
  </div>
  <div class="mb-3" id="selectCont7" style="display: none;">
    <label for="conturi7">Conturi de 7:</label>
    <select id="conturi7" name="conturi7[]" class="form-select" multiple>
      <option value="select_all">🔘 Selectează toate</option>
      {% for item in values_7 %}
      <option value="{{ item.GL }}">{{ item.GL }}</option>
    {% endfor %}
    </select>
  </div>

  <!-- Butoane acțiune -->
  <div class="d-flex gap-3 mt-4">
    <button id="genereazaFisa" type="submit" class="btn btn-primary">
      <i class="bi bi-play-circle"></i> Generează Fișa de Cont
    </button>
    <button id="cancelFisa" type="button" class="btn btn-outline-danger">
      <i class="bi bi-x-circle"></i> Anulează
    </button>
  </div>
</div>
  </div>
</form><form method="POST">
  <div class="row g-4">
    <div class="col-md-6 col-lg-4">
      <label for="start-date" class="form-label">Perioada de început</label>
      <input type="month" class="form-control form-control-lg rounded-3 shadow-sm" id="start-date" name="start-date" required>
    </div>
    <div class="col-md-6 col-lg-4">
      <label for="end-date" class="form-label">Perioada de sfârșit</label>
      <input type="month" class="form-control form-control-lg rounded-3 shadow-sm" id="end-date" name="end-date" required>
    </div>
     <hr class="my-4">

  <div class="d-flex flex-wrap gap-3">
    <button class="btn btn-outline-primary px-4 py-2 shadow-sm d-flex align-items-center gap-2" name="action" value="tb">
      <i class="bi bi-bar-chart-steps fs-5"></i> Balanța
    </button>
    <button id="btn-fisa" class="btn btn-outline-secondary px-4 py-2 shadow-sm d-flex align-items-center gap-2" name="action" value="fisa">
    <i class="bi bi-journal-bookmark fs-5"></i> Fișa de Cont
  </button>
    <button class="btn btn-outline-success px-4 py-2 shadow-sm d-flex align-items-center gap-2" name="action" value="gl">
      <i class="bi bi-diagram-3 fs-5"></i> GL Mapat
    </button>
  </div>
  
</div>




    <!-- Dummy Table with Filters -->
        <div class="card mt-4">
      <div class="card-header"><i class="bi bi-eye me-1"></i> Vizualizare Rapoarte

     
      </div>
      <div class="card-body">
         {% if fisier and fisier|length > 0 %}
         <div class="d-flex justify-content-end mb-3">
<!-- <div class="d-flex justify-content-end mb-3"> -->
  <button type="button" class="btn btn-outline-success" onclick="exportTableToExcel('tb-table', '{{ nume_export }}')">
  <i class="bi bi-file-earmark-excel"></i> Exportă în Excel
</button>

<!-- </div> -->
</div>

      <div class="table-responsive">
        <table  id="tb-table" class="table table-bordered table-striped">
          <thead>
            <tr> 
              <th>#</th>
              {% for col in fisier[0].keys() %}
                <th>{{ col }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in fisier %}
              <tr>
                <td>{{ loop.index }}</td>
                {% for col in row.values() %}
                  <td>{{ col }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">Nu există înregistrări de afisat.</p>
    {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>
</form>


  <!-- Footer -->
  

  <!-- Bootstrap JS and Popper.js -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" crossorigin="anonymous"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script> -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>



  <!-- Custom JavaScript -->
<script>
const startInput = document.getElementById('start-date');        // input luna inițială (selector original)
const endInput = document.getElementById('end-date');            // input luna finală (selector original)

const displayStart = document.getElementById('start-date-fisa'); // input readonly vizibil
const displayEnd = document.getElementById('end-date-fisa');     // input readonly vizibil

function updateDateFields() {
  const start = startInput.value;
  const end = endInput.value;

  displayStart.value = start || '-';
  displayEnd.value = end || '-';
}

// ascultă modificări pe selectorii originali
startInput.addEventListener('input', updateDateFields);
endInput.addEventListener('input', updateDateFields);

  $(document).ready(function () {
    function initSelectWithSelectAll(selector) {
      $(selector).select2({
        placeholder: "Selectează conturi",
        allowClear: true,
        width: '100%'
      });

      $(selector).on('select2:select', function (e) {
        if (e.params.data.id === 'select_all') {
          let allOptions = $(selector).find('option').not('[value="select_all"]');
          allOptions.prop('selected', true);
          $(selector).val(allOptions.map(function () {
            return this.value;
          }).get()).trigger('change');
        }
      });
    }

    initSelectWithSelectAll('#conturi6');
    initSelectWithSelectAll('#conturi7');

    $('#btn-fisa').on('click', function (e) {
      e.preventDefault();
      $('#dropdown-container').slideDown();
    });

    $('#checkCont6').on('change', function () {
      $('#selectCont6').toggle(this.checked);
      if (!this.checked) {
        $('#conturi6').val(null).trigger('change');
      }
    });

    $('#checkCont7').on('change', function () {
      $('#selectCont7').toggle(this.checked);
      if (!this.checked) {
        $('#conturi7').val(null).trigger('change');
      }
    });

    // 🔄 Buton "Anulează" — resetează tot
    $('#cancelFisa').on('click', function () {
      $('#checkCont6, #checkCont7').prop('checked', false);
      $('#conturi6, #conturi7').val(null).trigger('change');
      $('#selectCont6, #selectCont7').hide();
      $('#dropdown-container').slideUp();
    });

    // ✅ Buton "Generează Fișa de Cont" — exemplu simplu
    // $('#genereazaFisa').on('click', function () {
    //   const c6 = $('#conturi6').val() || [];
    //   const c7 = $('#conturi7').val() || [];

    //   if (!c6.length && !c7.length) {
    //     alert("Selectează cel puțin un cont pentru a genera fișa.");
    //   } else {
    //     alert("Generare fișă pentru:\nConturi 6: " + c6.join(', ') + "\nConturi 7: " + c7.join(', '));
    //     // Aici poți face submit, ajax, etc.
    //   }
    // });
  });

document.getElementById('fisaForm').addEventListener('submit', function(e) {
    e.preventDefault(); // oprește submitul clasic

    const formData = new FormData(this);

    fetch("{{ url_for('views.genereaza_fisa') }}", {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json()) // sau .text() dacă serverul returnează altceva
    .then(data => {
        console.log('Răspuns de la server:', data);
        // Redirect la pagina dorită (poți schimba URL-ul cu ce vrei)
        window.location.href = "{{ url_for('views.generate_reports_processing') }}";
    })
    .catch(error => {
        console.error('Eroare:', error);
    });
});

function exportTableToExcel(tableID, filename = 'export') {
    const table = document.getElementById(tableID);
    const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });

    const blob = new Blob([wbout], {
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });

    // Salvare locală DOAR dacă filename NU începe cu 'GL' (case insensitive)
    if (!filename.toLowerCase().startsWith('gl')) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename + '.xlsx';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Trimite la Flask
    const file = new File([blob], filename + '.xlsx', {
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });

    const formData = new FormData();
    formData.append('file', file);

    fetch('/trimite-mail-export', {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        alert('Email trimis cu succes!');
      } else {
        alert('Eroare: ' + data.message);
      }
    })
    .catch(err => {
      console.error(err);
      alert('A apărut o eroare.');
    });
  }

let activeFilters = {};  // Stocăm filtrele active pentru fiecare coloană

window.exportTableToExcel = exportTableToExcel;


document.addEventListener("DOMContentLoaded", function () {
  const headers = document.querySelectorAll(".filterable");

  headers.forEach(header => {
    header.addEventListener("click", function (event) {
      event.stopPropagation();

      // Eliminăm orice dropdown existent
      document.querySelectorAll('.dropdown-menu').forEach(menu => menu.remove());

      const index = Array.from(header.parentNode.children).indexOf(header);
      const dropdown = createDropdown(index);

      document.body.appendChild(dropdown); // Îl plasăm în body pentru a ieși din card

      // Calculăm poziția exactă a header-ului
      const rect = header.getBoundingClientRect();
      dropdown.style.top = `${rect.bottom + window.scrollY}px`;
      dropdown.style.left = `${rect.left + window.scrollX}px`;
      dropdown.classList.add("show");
    });
  });

  // Creăm dropdown-ul pentru fiecare coloană
  function createDropdown(index) {
    const dropdown = document.createElement("div");
    dropdown.classList.add("dropdown-menu");

    dropdown.innerHTML = `
      <div class="clear-filter">
        <button class="btn btn-link" id="clear-filter-${index}">Șterge Filtrul</button>
      </div>
      <div class="filter-search">
        <input type="text" class="form-control" placeholder="Căutare..." id="search-input-${index}">
      </div>
      <div class="dropdown-item select-all">
        <input type="checkbox" id="select-all-${index}"> Selectează toate
      </div>
    `;

    // Obținem valorile pentru coloana respectivă
    const columnValues = Array.from(document.querySelectorAll(`table tbody tr td:nth-child(${index + 1})`))
      .map(td => td.textContent.trim());
    const uniqueValues = [...new Set(columnValues)];

    // Actualizăm dropdown-ul pentru a include doar valorile vizibile
    updateDropdownValues(index, dropdown, uniqueValues);

    // Permite click pe text pentru a bifa checkbox-ul
    dropdown.querySelectorAll('.dropdown-item').forEach(item => {
      item.addEventListener("click", function (event) {
        if (!event.target.matches("input[type='checkbox']")) {
          const checkbox = item.querySelector("input[type='checkbox']");
          checkbox.checked = !checkbox.checked;
          applyFilter(index);
        }
      });
    });

    // Gestionăm inputul de căutare
    const searchInput = dropdown.querySelector(`#search-input-${index}`);
    searchInput.addEventListener("input", function () {
      const filter = searchInput.value.toLowerCase();
      const items = dropdown.querySelectorAll('.dropdown-item');
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(filter) ? '' : 'none';
      });
    });

    // Gestionăm "Selectează toate"
    const selectAllCheckbox = dropdown.querySelector(`#select-all-${index}`);
    selectAllCheckbox.addEventListener("change", function () {
      const checkboxes = dropdown.querySelectorAll(`.filter-checkbox-${index}`);
      checkboxes.forEach(checkbox => checkbox.checked = selectAllCheckbox.checked);
      applyFilter(index);
    });

    // Butonul "Șterge Filtrul"
    const clearFilterButton = dropdown.querySelector(`#clear-filter-${index}`);
    clearFilterButton.addEventListener("click", function () {
      // Debifăm toate checkbox-urile
      const checkboxes = dropdown.querySelectorAll(`.filter-checkbox-${index}`);
      checkboxes.forEach(checkbox => checkbox.checked = false);
      activeFilters[index] = []; // Resetăm filtrele active
      applyFilter(index); // Aplicăm filtrul gol
      // updateDropdownOptions();
    });

    return dropdown;
  }

  // Funcție pentru a actualiza dropdown-ul cu valorile vizibile
  function updateDropdownValues(index, dropdown, allValues) {
    // Obținem valorile vizibile în tabel
    const rows = document.querySelectorAll("table tbody tr");
    const visibleValues = new Set();

    rows.forEach(row => {
      if (row.style.display !== "none") {
        const cell = row.children[index];
        visibleValues.add(cell.textContent.trim());
      }
    });

    // Filtrăm valorile din dropdown pentru a include doar valorile vizibile
    const uniqueVisibleValues = [...new Set(allValues.filter(value => visibleValues.has(value)))];

    // Adăugăm itemele la dropdown
    const checkboxes = dropdown.querySelectorAll(`.filter-checkbox-${index}`);
    checkboxes.forEach(checkbox => checkbox.remove());  // Curățăm vechile checkbox-uri

    uniqueVisibleValues.forEach(value => {
      const item = document.createElement("div");
      item.classList.add("dropdown-item");
      item.innerHTML = `
        <input type="checkbox" class="filter-checkbox-${index}" value="${value}"> ${value}
      `;
      dropdown.appendChild(item);
    });

    // Restaurăm stările checkbox-urilor
    uniqueVisibleValues.forEach(value => {
      const checkbox = dropdown.querySelector(`.filter-checkbox-${index}[value="${value}"]`);
      if (activeFilters[index] && activeFilters[index].includes(value)) {
        checkbox.checked = true;
      }
    });
  }

  // Aplică filtrul și ascunde/afișează rândurile în funcție de filtrele active
  function applyFilter(index) {
    const checkboxes = document.querySelectorAll(`.filter-checkbox-${index}:checked`);
    const filterValues = Array.from(checkboxes).map(checkbox => checkbox.value);

    // Salvăm filtrele active
    activeFilters[index] = filterValues;

    const rows = document.querySelectorAll("table tbody tr");

    rows.forEach(row => {
        let isVisible = true;

        // Verificăm toate filtrele active pentru a decide dacă rândul rămâne vizibil
        Object.keys(activeFilters).forEach(colIndex => {
            const cell = row.children[colIndex];
            const cellValue = cell.textContent.trim();
            const colFilterValues = activeFilters[colIndex] || [];

            if (colFilterValues.length > 0 && !colFilterValues.includes(cellValue)) {
                isVisible = false;
            }
        });

        row.style.display = isVisible ? "" : "none";
    });

    updateDropdownOptions(); // 🔥 Actualizăm opțiunile din dropdown în timp real
}



// 🔄 Funcție care reface opțiunile disponibile în dropdown
function updateDropdownOptions() {
    document.querySelectorAll(".dropdown-menu").forEach(dropdown => {
        const index = dropdown.getAttribute("data-index");

        if (index !== null) {
            const columnIndex = parseInt(index);
            const visibleValues = new Set();

            document.querySelectorAll(`table tbody tr:not([style*="display: none"]) td:nth-child(${columnIndex + 1})`)
                .forEach(td => visibleValues.add(td.textContent.trim()));

            // Eliminăm vechile opțiuni, dar păstrăm "Selectează toate" și căutarea
            dropdown.querySelectorAll(".dropdown-item:not(.select-all)").forEach(item => item.remove());

            // Adăugăm doar valorile vizibile
            visibleValues.forEach(value => {
                const item = document.createElement("div");
                item.classList.add("dropdown-item");
                item.innerHTML = `
                    <input type="checkbox" class="filter-checkbox-${index}" value="${value}"> ${value}
                `;
                dropdown.appendChild(item);
            });

            // Reactualizăm evenimentele pentru checkbox-uri
            dropdown.querySelectorAll(".filter-checkbox-" + index).forEach(checkbox => {
                checkbox.addEventListener("change", function () {
                    applyFilter(index);
                });

                // Restaurăm checkbox-urile bifate anterior
                if (activeFilters[index] && activeFilters[index].includes(checkbox.value)) {
                    checkbox.checked = true;
                }
            });

            // ✅ Actualizăm și butonul "Selectează toate" în funcție de ce e afișat
            updateSelectAllState(index, dropdown);
        }
    });
}


  // Închidem dropdown-urile când se face click în afara acestora
  document.addEventListener("click", function (event) {
    const dropdowns = document.querySelectorAll('.dropdown-menu');
    let isClickInsideDropdown = false;

    dropdowns.forEach(dropdown => {
      if (dropdown.contains(event.target)) {
        isClickInsideDropdown = true;
      }
    });

    if (!isClickInsideDropdown) {
      dropdowns.forEach(menu => menu.remove());
    }
  });
  // updateDropdownOptions();
});
function updateSelectAllState(index, dropdown) {
    const selectAllCheckbox = dropdown.querySelector(`#select-all-${index}`);
    const allCheckboxes = dropdown.querySelectorAll(`.filter-checkbox-${index}`);
    const visibleCheckboxes = Array.from(allCheckboxes).filter(cb => cb.parentElement.style.display !== "none");

    const allChecked = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked);
    selectAllCheckbox.checked = allChecked;

    // Când apăs pe "Selectează toate", bifează doar cele vizibile
    selectAllCheckbox.addEventListener("change", function () {
        visibleCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
        applyFilter(index);
    });
}
document.addEventListener("DOMContentLoaded", function () {
      // Dropdown pentru Utilizatori
      let usersDropdown = document.getElementById("usersDropdown");
  
      if (usersDropdown) {
        usersDropdown.addEventListener("mouseenter", function () {
          let menu = this.querySelector(".dropdown-menu");
          menu.classList.add("show");  // Afișează dropdown-ul
        });
  
        usersDropdown.addEventListener("mouseleave", function () {
          let menu = this.querySelector(".dropdown-menu");
          menu.classList.remove("show");  // Ascunde dropdown-ul
        });
      }
  
      // Dropdown pentru Utilizator Autentificat
      let userDropdown = document.getElementById("userDropdown");
  
      if (userDropdown) {
        userDropdown.addEventListener("mouseenter", function () {
          let menu = this.querySelector(".dropdown-menu");
          menu.classList.add("show");  // Afișează dropdown-ul
        });
  
        userDropdown.addEventListener("mouseleave", function () {
          let menu = this.querySelector(".dropdown-menu");
          menu.classList.remove("show");  // Ascunde dropdown-ul
        });
      }
    });
  </script>
</body>
</html>
